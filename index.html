<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Control Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #070b12;
      --card: #101623;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --border: #1f2933;
      --input: #0b111c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 8px;
    }

    .app-container {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
      padding: 20px 24px 28px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .clock-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .clock-line {
      font-size: 14px;
      font-weight: 500;
    }

    .status-pill {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-pre {
      background: rgba(245, 158, 11, 0.1);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .status-open {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .status-after {
      background: rgba(96, 165, 250, 0.14);
      color: #93c5fd;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    .status-closed {
      background: rgba(148, 163, 184, 0.06);
      color: #cbd5f5;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    /* Portfolio section */
    .portfolio-row {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .portfolio-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .portfolio-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .portfolio-input {
      width: 200px;
      padding: 7px 11px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: var(--input);
      color: var(--text);
      font-size: 15px;
      font-weight: 500;
      outline: none;
      transition: 0.12s ease;
    }

    .portfolio-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
    }

    .portfolio-value {
      font-size: 15px;
      font-weight: 600;
      color: #4ade80;
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.7);
      padding: 3px;
      margin-bottom: 16px;
      width: fit-content;
    }

    .tab-button {
      border: none;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .tab-button.active {
      background: radial-gradient(circle at top left, #2563eb, #1d4ed8);
      color: #e5f0ff;
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.4),
        0 6px 14px rgba(37, 99, 235, 0.45);
    }

    .tab-icon {
      font-size: 15px;
    }

    .content {
      margin-top: 6px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.6);
      margin-bottom: 16px;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-note {
      font-size: 11px;
      color: var(--muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 22px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px 22px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
    }

    .input,
    .select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: var(--input);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.12s ease;
    }

    .input:focus,
    .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
    }

    .input::placeholder {
      color: #6b7280;
    }

    .input[readonly] {
      background: rgba(15, 23, 42, 0.5);
      color: var(--muted);
      cursor: not-allowed;
    }

    .section-divider {
      border: none;
      border-top: 1px dashed rgba(55, 65, 81, 0.8);
      margin: 14px 0 10px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 16px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .summary-item {
      font-size: 13px;
      color: var(--muted);
    }

    .summary-item span {
      color: var(--text);
      font-weight: 500;
    }

    .summary-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    .summary-badge.free {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.16);
    }

    .summary-badge.paid {
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.16);
    }

    .fees-card {
      margin-top: 2px;
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 12px 10px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .fees-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .fees-title {
      font-size: 13px;
      font-weight: 600;
    }

    .fees-body {
      font-size: 12px;
      color: var(--muted);
    }

    .fee-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }

    .fee-name {
      color: #9ca3af;
    }

    .fee-value {
      color: #e5e7eb;
      font-variant-numeric: tabular-nums;
    }

    .fee-total {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(75, 85, 99, 0.9);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    .fee-total-label {
      color: #e5e7eb;
    }

    .fee-total-value {
      color: #fbbf24;
    }

    .net-row {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    .net-label {
      color: #e5e7eb;
    }

    .net-value {
      color: #93c5fd;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .btn-execute {
      background: transparent;
      color: var(--success);
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .btn-execute:hover {
      background: var(--success);
      color: #ffffff;
      transform: translateY(-1px);
    }

    .btn-cancel {
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(249, 115, 115, 0.7);
    }

    .btn-cancel:hover {
      background: var(--danger);
      color: #ffffff;
      transform: translateY(-1px);
    }

    .status-text {
      font-size: 12px;
      margin-top: 6px;
      color: var(--muted);
    }

    .status-text span {
      color: #e5e7eb;
    }

    /* Risk gauge */
    .gauge-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
    }

    .gauge-wrapper {
      position: relative;
      width: 280px;
      height: 280px;
    }

    .gauge-svg {
      width: 100%;
      height: 100%;
    }

    .gauge-needle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 3px;
      height: 115px;
      background: #ffffff;
      transform-origin: 50% 100%;
      transform: translate(-50%, -100%) rotate(0deg);
      transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px 2px 0 0;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    .gauge-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      background: #ffffff;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
    }

    .gauge-label {
      text-align: center;
      margin-top: 16px;
    }

    .risk-status-text {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .risk-status-text.green {
      color: #4ade80;
    }

    .risk-status-text.yellow {
      color: #fbbf24;
    }

    .risk-status-text.red {
      color: #f97373;
    }

    .risk-message {
      font-size: 13px;
      color: var(--muted);
      max-width: 500px;
      margin: 0 auto;
    }

    /* Risk grid */
    .risk-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 18px;
      font-size: 13px;
    }

    .risk-item-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .risk-item-value {
      margin-top: 2px;
      color: #e5e7eb;
      font-variant-numeric: tabular-nums;
    }

    /* Profit table */
    .profit-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .profit-table thead th {
      background: rgba(15, 23, 42, 0.8);
      padding: 10px 12px;
      text-align: left;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid #1f2937;
    }

    .profit-table tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(31, 41, 51, 0.5);
      font-size: 13px;
    }

    .profit-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .profit-loss {
      color: #f97373;
      font-weight: 500;
    }

    .profit-gain {
      color: #4ade80;
      font-weight: 500;
    }

    /* Saved trades table */
    .trades-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .trades-table thead th {
      background: rgba(15, 23, 42, 0.8);
      padding: 10px 12px;
      text-align: left;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 1px solid #1f2937;
    }

    .trades-table tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(31, 41, 51, 0.5);
      font-size: 13px;
    }

    .trades-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    .side-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .side-badge.long {
      background: rgba(34, 197, 94, 0.16);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .side-badge.short {
      background: rgba(249, 115, 115, 0.16);
      color: #f97373;
      border: 1px solid rgba(249, 115, 115, 0.5);
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 16px 14px 22px;
      }
      .header-row {
        align-items: flex-start;
      }
      .clock-block {
        align-items: flex-start;
      }
      .grid-2,
      .grid-3,
      .risk-grid {
        grid-template-columns: 1fr;
      }
      .tabs {
        width: 100%;
      }
      .actions-row {
        justify-content: flex-start;
      }
      .portfolio-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .portfolio-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <div class="header-row">
      <div class="title-block">
        <div class="title">Trading Control Center</div>
        <div class="subtitle">
          Fee Structure &amp; Risk Management ‚Ä¢ TradeZero-style fee model
        </div>
      </div>
      <div class="clock-block">
        <div class="clock-line" id="clockDisplay">--/--/---- --:-- -- EST</div>
        <div id="marketStatusPill" class="status-pill status-closed">
          <span id="marketStatusText">Market Closed</span>
        </div>
      </div>
    </div>

    <!-- PORTFOLIO -->
    <div class="portfolio-row">
      <div class="portfolio-field">
        <div class="portfolio-label">Portfolio</div>
        <input
          type="text"
          class="portfolio-input"
          id="portfolioInput"
          placeholder="Enter amount"
        />
      </div>
      <div class="portfolio-field">
        <div class="portfolio-label">Margin Amount</div>
        <div class="portfolio-value" id="marginAmount">$0.00</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-button active" data-tab="fees">
        <span class="tab-icon">üìä</span>
        Fee Structure
      </button>
      <button class="tab-button" data-tab="risk">
        <span class="tab-icon">üõ°Ô∏è</span>
        Risk Management
      </button>
      <button class="tab-button" data-tab="portfolio">
        <span class="tab-icon">üìà</span>
        Current Portfolio
      </button>
      <button class="tab-button" data-tab="saved">
        <span class="tab-icon">üíæ</span>
        Saved Trades
      </button>
    </div>

    <div class="content">
      <!-- FEE STRUCTURE TAB -->
      <div class="tab-panel active" id="tab-fees">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Order Inputs</div>
            <div class="card-note">
              Fill in symbol, side, price, shares, and locate fee (if short).
            </div>
          </div>

          <div class="grid-3">
            <div class="field">
              <label for="tickerInput">Ticker Symbol</label>
              <input
                id="tickerInput"
                class="input"
                type="text"
                placeholder="e.g. AAPL"
                style="text-transform: uppercase;"
              />
            </div>

            <div class="field">
              <label for="indexInput">Index</label>
              <input
                id="indexInput"
                class="input"
                type="text"
                placeholder="Auto-detected"
                readonly
              />
            </div>

            <div class="field">
              <label for="orderType">Order Type</label>
              <select id="orderType" class="select">
                <option value="limit">Limit</option>
                <option value="market">Market</option>
              </select>
            </div>

            <div class="field">
              <label for="side">Side</label>
              <select id="side" class="select">
                <option value="long">Long</option>
                <option value="short">Short</option>
              </select>
            </div>

            <div class="field">
              <label for="tradePrice">Trade Price (per share, USD)</label>
              <input
                id="tradePrice"
                class="input"
                type="number"
                step="0.01"
                min="0"
                placeholder="e.g. 10.00"
              />
            </div>

            <div class="field">
              <label for="shares">Shares</label>
              <input
                id="shares"
                class="input"
                type="number"
                step="1"
                min="0"
                placeholder="e.g. 100"
              />
            </div>

            <div class="field" id="locateField" style="display: none;">
              <label for="locateFee">Locate Fee (USD, for shorts)</label>
              <input
                id="locateFee"
                class="input"
                type="number"
                step="0.01"
                min="0"
                placeholder="e.g. 1.12"
              />
            </div>
          </div>

          <hr class="section-divider" />

          <div class="summary-row">
            <div class="summary-item">
              Order:
              <span id="summaryOrder">--</span>
            </div>
            <div class="summary-item">
              Gross Amount:
              <span id="summaryGross">$0.00</span>
            </div>
            <div class="summary-item">
              ZeroFree Status:
              <span id="summaryZeroFree">--</span>
            </div>
            <div>
              <span id="summaryBadge" class="summary-badge">
                Waiting for input
              </span>
            </div>
          </div>

          <div class="fees-card">
            <div class="fees-header">
              <div class="fees-title">Fee Breakdown</div>
              <div class="fees-body" style="font-size: 11px;">
                TradeZero commission structure with regulatory fees.
              </div>
            </div>
            <div class="fees-body" id="feesBody">
              <div class="fee-row">
                <div class="fee-name">Commission</div>
                <div class="fee-value" id="feeCommission">$0.00</div>
              </div>
              <div class="fee-row">
                <div class="fee-name">TAF</div>
                <div class="fee-value" id="feeTAF">$0.00</div>
              </div>
              <div class="fee-row">
                <div class="fee-name">Locate Fee</div>
                <div class="fee-value" id="feeLocate">$0.00</div>
              </div>

              <div class="fee-total">
                <div class="fee-total-label">Total Fees</div>
                <div class="fee-total-value" id="feeTotal">$0.00</div>
              </div>

              <div class="net-row">
                <div class="net-label">Net Amount (entry cost)</div>
                <div class="net-value" id="netAmount">$0.00</div>
              </div>
            </div>
          </div>

          <div class="status-text">
            Status:
            <span id="statusMessage">
              Waiting for inputs. Fill out price and shares to calculate fees.
            </span>
          </div>

          <div class="actions-row">
            <button class="btn btn-cancel" id="cancelButton">
              ‚úñ Cancel Trade
            </button>
            <button class="btn btn-execute" id="executeButton">
              ‚úÖ Execute Trade
            </button>
          </div>
        </div>
      </div>

      <!-- RISK MANAGEMENT TAB -->
      <div class="tab-panel" id="tab-risk">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Position Risk Analysis</div>
            <div class="card-note">
              Based on your margin and fees.
            </div>
          </div>

          <div class="gauge-container">
            <div class="gauge-wrapper">
              <svg class="gauge-svg" viewBox="0 0 200 200">
                <!-- Green segment (0-34%) -->
                <circle
                  cx="100"
                  cy="100"
                  r="85"
                  fill="none"
                  stroke="#4ade80"
                  stroke-width="30"
                  stroke-dasharray="181 360"
                  stroke-dashoffset="0"
                  transform="rotate(-90 100 100)"
                />
                <!-- Yellow segment (34-66%) -->
                <circle
                  cx="100"
                  cy="100"
                  r="85"
                  fill="none"
                  stroke="#fbbf24"
                  stroke-width="30"
                  stroke-dasharray="170 360"
                  stroke-dashoffset="-181"
                  transform="rotate(-90 100 100)"
                />
                <!-- Red segment (66-100%) -->
                <circle
                  cx="100"
                  cy="100"
                  r="85"
                  fill="none"
                  stroke="#f97373"
                  stroke-width="30"
                  stroke-dasharray="181 360"
                  stroke-dashoffset="-351"
                  transform="rotate(-90 100 100)"
                />
              </svg>
              <div class="gauge-needle" id="gaugeNeedle"></div>
              <div class="gauge-center"></div>
            </div>
            <div class="gauge-label">
              <div class="risk-status-text green" id="riskStatusText">
                Acceptable / Controlled Risk
              </div>
              <div class="risk-message" id="riskMessage">
                Enter portfolio value and order details to see position risk.
              </div>
            </div>
          </div>

          <div class="risk-grid">
            <div>
              <div class="risk-item-label">Margin Portfolio</div>
              <div class="risk-item-value" id="riskMargin">$0.00</div>
            </div>
            <div>
              <div class="risk-item-label">Risked Amount (Net)</div>
              <div class="risk-item-value" id="riskNet">$0.00</div>
            </div>
            <div>
              <div class="risk-item-label">Side</div>
              <div class="risk-item-value" id="riskSide">--</div>
            </div>
            <div>
              <div class="risk-item-label">Risk Percentage</div>
              <div class="risk-item-value" id="riskPercent">0%</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Profit Targets (price movement needed after fees)</div>
          <table class="profit-table">
            <thead>
              <tr>
                <th>Percent Range</th>
                <th>Price Range</th>
                <th>Profit Range</th>
              </tr>
            </thead>
            <tbody id="profitTableBody">
              <tr>
                <td colspan="3" style="text-align: center; color: var(--muted);">
                  No trade data yet
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <div class="card-title-row">
            <div class="card-title">ü§ñ Risk Analysis Assistant</div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button 
                onclick="showWorkerUrlPrompt()" 
                class="btn btn-ghost" 
                style="padding: 4px 10px; font-size: 11px;"
                title="Set Worker URL"
              >
                ‚öôÔ∏è Setup
              </button>
              <div class="card-note">
                Ask questions about your position risk
              </div>
            </div>
          </div>
          
          <div id="chatMessages" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px; padding: 10px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #1f2937;">
            <div style="color: var(--muted); font-size: 13px; text-align: center; padding: 20px;">
              üí¨ Ask me anything about your risk management, position sizing, or trade strategy!<br><br>
              <span style="font-size: 11px; color: #6b7280;">First time? Click "‚öôÔ∏è Setup" to add your Cloudflare Worker URL.</span>
            </div>
          </div>

          <div style="display: flex; gap: 8px;">
            <input
              type="text"
              id="chatInput"
              class="input"
              placeholder="Ask about your risk... (e.g., 'Is this position too risky?')"
              style="flex: 1;"
            />
            <button class="btn btn-execute" id="chatSendButton" style="flex-shrink: 0;">
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- SAVED TRADES TAB -->
      <div class="tab-panel" id="tab-saved">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Saved Trades (Browser Log)</div>
            <div class="card-note">
              Stored locally in your browser.
            </div>
          </div>
          <table class="trades-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Symbol</th>
                <th>Side</th>
                <th>Type</th>
                <th>Price</th>
                <th>Shares</th>
                <th>Fees</th>
                <th>Net</th>
              </tr>
            </thead>
            <tbody id="savedTradesBody">
              <tr>
                <td colspan="9" style="text-align: center; color: var(--muted);">
                  No saved trades yet
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CURRENT PORTFOLIO TAB -->
      <div class="tab-panel" id="tab-portfolio">
        <!-- Daily P&L Summary -->
        <div class="card" style="margin-bottom: 16px;">
          <div class="card-title">üìä Daily Performance</div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
            <div style="padding: 16px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #1f2937;">
              <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">Total P&L Today</div>
              <div id="dailyPnL" style="font-size: 24px; font-weight: 700; color: var(--muted);">$0.00</div>
            </div>
            <div style="padding: 16px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #1f2937;">
              <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">Trades Today</div>
              <div id="tradesCount" style="font-size: 24px; font-weight: 700; color: #e5e7eb;">0</div>
            </div>
            <div style="padding: 16px; background: rgba(15, 23, 42, 0.5); border-radius: 8px; border: 1px solid #1f2937;">
              <div style="font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 4px;">Win Rate</div>
              <div id="winRate" style="font-size: 24px; font-weight: 700; color: #e5e7eb;">0%</div>
            </div>
          </div>
        </div>

        <!-- Open Positions -->
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Open Positions</div>
            <div class="card-note">
              Enter sale price to close position
            </div>
          </div>
          <div style="overflow-x: auto;">
            <table class="trades-table">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Shares</th>
                  <th>Entry Price</th>
                  <th>Entry Cost</th>
                  <th>Risk %</th>
                  <th>Price Sold</th>
                  <th>P&L</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="openPositionsBody">
                <tr>
                  <td colspan="9" style="text-align: center; color: var(--muted);">
                    No open positions
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Closed Positions (Today) -->
        <div class="card" style="margin-top: 16px;">
          <div class="card-title">Closed Positions (Today)</div>
          <div style="overflow-x: auto;">
            <table class="trades-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Shares</th>
                  <th>Entry</th>
                  <th>Exit</th>
                  <th>Total Fees</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody id="closedPositionsBody">
                <tr>
                  <td colspan="8" style="text-align: center; color: var(--muted);">
                    No closed positions today
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

  <script>
    // ========== ELEMENT REFERENCES (Declare all elements first) ==========
    const portfolioInput = document.getElementById("portfolioInput");
    const marginAmount = document.getElementById("marginAmount");
    
    const tickerInput = document.getElementById("tickerInput");
    const indexInput = document.getElementById("indexInput");
    const orderTypeSelect = document.getElementById("orderType");
    const sideSelect = document.getElementById("side");
    const tradePriceInput = document.getElementById("tradePrice");
    const sharesInput = document.getElementById("shares");
    const locateField = document.getElementById("locateField");
    const locateFeeInput = document.getElementById("locateFee");

    const summaryOrder = document.getElementById("summaryOrder");
    const summaryGross = document.getElementById("summaryGross");
    const summaryZeroFree = document.getElementById("summaryZeroFree");
    const summaryBadge = document.getElementById("summaryBadge");

    const feeCommission = document.getElementById("feeCommission");
    const feeTAF = document.getElementById("feeTAF");
    const feeLocate = document.getElementById("feeLocate");
    const feeTotal = document.getElementById("feeTotal");
    const netAmount = document.getElementById("netAmount");
    const statusMessage = document.getElementById("statusMessage");

    const executeButton = document.getElementById("executeButton");
    const cancelButton = document.getElementById("cancelButton");

    // State
    let currentTradeData = null;
    let savedTrades = JSON.parse(localStorage.getItem("savedTrades")) || [];
    let openPositions = JSON.parse(localStorage.getItem("openPositions")) || [];
    let closedPositions = JSON.parse(localStorage.getItem("closedPositions")) || [];
    let dailyPnLData = JSON.parse(localStorage.getItem("dailyPnLData")) || [];

    // ========== UTILITIES ==========
    function formatMoney(value) {
      if (!isFinite(value)) return "$0.00";
      return "$" + value.toFixed(2);
    }

    function toEstDate(date) {
      return new Date(date.toLocaleString("en-US", { timeZone: "America/New_York" }));
    }

    function getMarketStatus(estDate) {
      const day = estDate.getDay();
      const hours = estDate.getHours();
      const minutes = estDate.getMinutes();
      const totalMinutes = hours * 60 + minutes;

      if (day === 0 || day === 6) {
        return { status: "After Market", class: "status-after" };
      }

      if (totalMinutes >= 240 && totalMinutes < 540) {
        return { status: "Pre-Market", class: "status-pre" };
      }
      if (totalMinutes >= 540 && totalMinutes < 960) {
        return { status: "Market Hours", class: "status-open" };
      }
      return { status: "After Market", class: "status-after" };
    }

    // ========== PORTFOLIO & MARGIN ==========

    portfolioInput.addEventListener("input", function(e) {
      let value = e.target.value.replace(/[^0-9.]/g, "");
      updateMarginAmount();
    });

    portfolioInput.addEventListener("blur", function(e) {
      let value = e.target.value.replace(/[^0-9.]/g, "");
      if (value) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue)) {
          e.target.value = "$" + numValue.toLocaleString("en-US", { minimumFractionDigits: 2 });
        }
      }
      updateMarginAmount();
    });

    portfolioInput.addEventListener("focus", function(e) {
      let value = e.target.value.replace(/[$,]/g, "");
      e.target.value = value;
    });

    function updateMarginAmount() {
      const portfolioValue = portfolioInput.value.replace(/[$,]/g, "");
      const portfolio = parseFloat(portfolioValue) || 0;

      if (portfolio < 500) {
        marginAmount.textContent = formatMoney(portfolio);
        return;
      }

      const now = new Date();
      const est = toEstDate(now);
      const totalMinutes = est.getHours() * 60 + est.getMinutes();

      let leverage = 1;
      if (totalMinutes >= 240 && totalMinutes < 960) {
        // 4 AM - 4 PM
        leverage = 3;
      } else if (totalMinutes >= 960 && totalMinutes < 1200) {
        // 4 PM - 8 PM
        leverage = 2;
      } else {
        // After 8 PM or before 4 AM
        leverage = 2;
      }

      const margin = portfolio * leverage;
      marginAmount.textContent = formatMoney(margin);
    }

    // ========== CLOCK ==========
    function updateClock() {
      const now = new Date();
      const est = toEstDate(now);

      const month = String(est.getMonth() + 1).padStart(2, "0");
      const day = String(est.getDate()).padStart(2, "0");
      const year = est.getFullYear();

      let hours = est.getHours();
      const minutes = String(est.getMinutes()).padStart(2, "0");
      const seconds = String(est.getSeconds()).padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      let displayHour = hours % 12;
      if (displayHour === 0) displayHour = 12;

      const clockDisplay = document.getElementById("clockDisplay");
      clockDisplay.textContent =
        month + "/" + day + "/" + year + " " + displayHour + ":" + minutes + ":" + seconds + " " + ampm + " EST";

      const status = getMarketStatus(est);
      const pill = document.getElementById("marketStatusPill");
      const text = document.getElementById("marketStatusText");

      pill.className = "status-pill " + status.class;
      text.textContent = status.status;

      updateMarginAmount();
    }

    setInterval(updateClock, 1000);
    updateClock();

    // ========== TAB SWITCHING ==========
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabPanels = {
      fees: document.getElementById("tab-fees"),
      risk: document.getElementById("tab-risk"),
      portfolio: document.getElementById("tab-portfolio"),
      saved: document.getElementById("tab-saved"),
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        Object.keys(tabPanels).forEach((key) => {
          tabPanels[key].classList.toggle("active", key === tab);
        });

        if (tab === "risk") {
          updateRiskManagement();
        } else if (tab === "saved") {
          displaySavedTrades();
        } else if (tab === "portfolio") {
          updatePortfolioTab();
        }
      });
    });

    // ========== LOGIC ==========
    function updateLocateVisibility() {
      if (sideSelect.value === "short") {
        locateField.style.display = "block";
      } else {
        locateField.style.display = "none";
        locateFeeInput.value = "";
      }
    }

    tickerInput.addEventListener("input", function(e) {
      const ticker = e.target.value.toUpperCase();
      e.target.value = ticker;

      // Simple index detection
      const otcPattern = /^[A-Z]{4,5}$/;
      if (ticker.length >= 4 && otcPattern.test(ticker)) {
        indexInput.value = "OTC/Pink Sheets";
      } else if (ticker.length >= 1 && ticker.length <= 4) {
        indexInput.value = "NYSE/NASDAQ/AMEX";
      } else {
        indexInput.value = "";
      }

      calculate();
    });

    sideSelect.addEventListener("change", () => {
      updateLocateVisibility();
      calculate();
    });

    orderTypeSelect.addEventListener("change", calculate);
    tradePriceInput.addEventListener("input", calculate);
    sharesInput.addEventListener("input", calculate);
    locateFeeInput.addEventListener("input", calculate);

    function calculate() {
      const ticker = tickerInput.value.trim().toUpperCase();
      const orderType = orderTypeSelect.value;
      const side = sideSelect.value;
      const price = parseFloat(tradePriceInput.value);
      const shares = parseInt(sharesInput.value, 10);
      const locate = parseFloat(locateFeeInput.value) || 0;

      // Summary order text
      if (!ticker && (!shares || !price)) {
        summaryOrder.textContent = "--";
      } else {
        summaryOrder.textContent =
          (side === "short" ? "Short " : "Long ") +
          (shares || 0) +
          " " +
          (ticker || "SYMBOL") +
          " @ " +
          (isFinite(price) ? "$" + price.toFixed(2) : "--") +
          " (" +
          (orderType === "limit" ? "Limit" : "Market") +
          ")";
      }

      let grossAmount = 0;
      if (isFinite(price) && isFinite(shares) && shares > 0) {
        grossAmount = price * shares;
      }
      summaryGross.textContent = formatMoney(grossAmount);

      // If no valid data, reset
      if (!isFinite(price) || !isFinite(shares) || shares <= 0 || price <= 0) {
        feeCommission.textContent = "$0.00";
        feeTAF.textContent = "$0.00";
        feeLocate.textContent = formatMoney(locate);
        feeTotal.textContent = formatMoney(locate);
        netAmount.textContent = formatMoney(grossAmount + locate);
        summaryZeroFree.textContent = "--";
        summaryBadge.className = "summary-badge";
        summaryBadge.textContent = "Waiting for input";
        statusMessage.textContent =
          "Waiting for inputs. Fill out price and shares to calculate fees.";

        currentTradeData = null;
        return;
      }

      // ZeroFree check
      let isZeroFree = false;
      if (orderType === "limit" && shares >= 200 && price >= 1) {
        isZeroFree = true;
      }

      // Commission
      let commission = 0;
      if (price < 1) {
        // Stocks under $1
        commission = shares * 0.005;
        commission = Math.max(0.99, Math.min(7.95, commission));
      } else if (isZeroFree) {
        commission = 0;
      } else if (orderType === "market" && shares < 200) {
        commission = 0.99;
      } else if (orderType === "market" && shares >= 200) {
        commission = shares * 0.005;
      } else {
        commission = 0.99;
      }

      // TAF
      const taf = 0.02;

      // Locate fee
      const locateFee = side === "short" ? locate : 0;

      const totalFees = commission + taf + locateFee;
      const net = grossAmount + totalFees;

      feeCommission.textContent = formatMoney(commission);
      feeTAF.textContent = formatMoney(taf);
      feeLocate.textContent = formatMoney(locateFee);
      feeTotal.textContent = formatMoney(totalFees);
      netAmount.textContent = formatMoney(net);

      summaryZeroFree.textContent = isZeroFree
        ? "Qualifies (ZeroFree)"
        : "Paid commission";

      if (isZeroFree) {
        summaryBadge.className = "summary-badge free";
        summaryBadge.textContent = "ZeroFree Trade";
        statusMessage.textContent =
          "This order meets ZeroFree conditions: Limit, ‚â•200 shares, price ‚â•$1.";
      } else {
        summaryBadge.className = "summary-badge paid";
        summaryBadge.textContent = "Commission Charged";
        statusMessage.textContent =
          "This order does not meet ZeroFree rules. Commission applies.";
      }

      currentTradeData = {
        ticker,
        index: indexInput.value,
        orderType,
        side,
        price,
        shares,
        locateFee,
        commission,
        taf,
        totalFees,
        grossAmount,
        netAmount: net,
        isZeroFree,
      };
    }

    // ========== EXECUTE & CANCEL ==========
    executeButton.addEventListener("click", () => {
      if (!currentTradeData || currentTradeData.netAmount === 0) {
        alert("Please enter trade details first");
        return;
      }

      const now = new Date();
      const est = toEstDate(now);

      const position = {
        ...currentTradeData,
        date: est.toLocaleDateString("en-US"),
        time: est.toLocaleTimeString("en-US"),
        timestamp: Date.now(),
        status: "open",
        entryFees: currentTradeData.totalFees,
        exitPrice: null,
        exitFees: null,
        pnl: null
      };

      openPositions.push(position);
      localStorage.setItem("openPositions", JSON.stringify(openPositions));

      alert("Trade executed! Position added to Current Portfolio.");
      clearOrderInputs();
      updatePortfolioTab();
    });

    cancelButton.addEventListener("click", () => {
      clearOrderInputs();
    });

    function clearOrderInputs() {
      tickerInput.value = "";
      indexInput.value = "";
      orderTypeSelect.value = "limit";
      sideSelect.value = "long";
      tradePriceInput.value = "";
      sharesInput.value = "";
      locateFeeInput.value = "";

      updateLocateVisibility();
      currentTradeData = null;
      calculate();
      clearRiskManagement();
    }

    // ========== RISK MANAGEMENT ==========
    function updateRiskManagement() {
      if (!currentTradeData || currentTradeData.netAmount === 0) {
        clearRiskManagement();
        return;
      }

      const marginText = marginAmount.textContent.replace(/[$,]/g, "");
      const margin = parseFloat(marginText) || 0;
      const net = currentTradeData.netAmount;

      document.getElementById("riskMargin").textContent = formatMoney(margin);
      document.getElementById("riskNet").textContent = formatMoney(net);
      document.getElementById("riskSide").textContent = currentTradeData.side.toUpperCase();

      const riskPercent = margin > 0 ? (net / margin) * 100 : 0;
      document.getElementById("riskPercent").textContent = Math.round(riskPercent) + "%";

      updateGauge(riskPercent);

      const statusEl = document.getElementById("riskStatusText");
      const messageEl = document.getElementById("riskMessage");

      if (riskPercent <= 34) {
        statusEl.textContent = "Acceptable / Controlled Risk";
        statusEl.className = "risk-status-text green";
        messageEl.textContent =
          "Your position size is well within safe limits. Good risk management!";
      } else if (riskPercent <= 66) {
        statusEl.textContent = "Moderate Risk";
        statusEl.className = "risk-status-text yellow";
        messageEl.textContent =
          "Position size is moderate. Consider if this aligns with your risk tolerance.";
      } else {
        statusEl.textContent = "High Risk";
        statusEl.className = "risk-status-text red";
        messageEl.textContent =
          "Position size exceeds your preferred risk; Cut down position size";
      }

      generateProfitTable();
    }

    function updateGauge(percentage) {
      const needle = document.getElementById("gaugeNeedle");
      const angle = (percentage / 100) * 360;
      needle.style.transform = `translate(-50%, -100%) rotate(${angle}deg)`;
    }

    function clearRiskManagement() {
      document.getElementById("riskMargin").textContent = "$0.00";
      document.getElementById("riskNet").textContent = "$0.00";
      document.getElementById("riskSide").textContent = "--";
      document.getElementById("riskPercent").textContent = "0%";
      document.getElementById("riskStatusText").textContent = "Acceptable / Controlled Risk";
      document.getElementById("riskStatusText").className = "risk-status-text green";
      document.getElementById("riskMessage").textContent =
        "Enter portfolio value and order details to see position risk.";
      updateGauge(0);

      const tbody = document.getElementById("profitTableBody");
      tbody.innerHTML =
        '<tr><td colspan="3" style="text-align: center; color: var(--muted);">No trade data yet</td></tr>';
    }

    function generateProfitTable() {
      if (!currentTradeData || currentTradeData.grossAmount === 0) return;

      const grossAmount = currentTradeData.grossAmount;
      const totalFees = currentTradeData.totalFees;
      const side = currentTradeData.side;
      const price = currentTradeData.price;

      const breakEvenDollar = totalFees;
      const breakEvenPercent = (breakEvenDollar / grossAmount) * 100;

      const tbody = document.getElementById("profitTableBody");
      tbody.innerHTML = "";

      // Row 1: Fee row (0% to breakeven%, in red)
      const row1 = tbody.insertRow();
      const feePercent = Math.ceil(breakEvenPercent * 100) / 100;
      
      // Calculate price range for fee row
      let feeMinPrice, feeMaxPrice;
      if (side === "long") {
        feeMinPrice = price; // 0% change
        feeMaxPrice = price * (1 + feePercent / 100);
      } else {
        // Short: price goes DOWN for profit
        feeMinPrice = price * (1 - feePercent / 100);
        feeMaxPrice = price; // 0% change
      }
      
      row1.innerHTML = `
        <td>0% - ${feePercent.toFixed(2)}%</td>
        <td>$${feeMinPrice.toFixed(2)} - $${feeMaxPrice.toFixed(2)}</td>
        <td class="profit-loss">$0.00 - $${breakEvenDollar.toFixed(2)}</td>
      `;

      // Determine starting percentage
      let startPercent = Math.ceil(breakEvenPercent);
      if (startPercent < 5) {
        startPercent = 5;
      } else if (startPercent % 5 !== 0) {
        startPercent = Math.ceil(startPercent / 5) * 5;
      }

      // Generate 5 more rows
      for (let i = 0; i < 5; i++) {
        const row = tbody.insertRow();
        const rangeStart = startPercent + i * 5;
        const rangeEnd = rangeStart + 5;

        const dollarStart = (grossAmount * rangeStart) / 100;
        const dollarEnd = (grossAmount * rangeEnd) / 100;

        // Calculate price range based on side
        let priceStart, priceEnd;
        if (side === "long") {
          // Long: price goes UP for profit
          priceStart = price * (1 + rangeStart / 100);
          priceEnd = price * (1 + rangeEnd / 100);
        } else {
          // Short: price goes DOWN for profit
          priceStart = price * (1 - rangeEnd / 100);
          priceEnd = price * (1 - rangeStart / 100);
        }

        row.innerHTML = `
          <td>${rangeStart}% - ${rangeEnd}%</td>
          <td>$${priceStart.toFixed(2)} - $${priceEnd.toFixed(2)}</td>
          <td class="profit-gain">$${dollarStart.toFixed(2)} - $${dollarEnd.toFixed(2)}</td>
        `;
      }
    }

    // ========== SAVED TRADES ==========
    function displaySavedTrades() {
      const tbody = document.getElementById("savedTradesBody");

      if (savedTrades.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="9" style="text-align: center; color: var(--muted);">No saved trades yet</td></tr>';
        return;
      }

      tbody.innerHTML = "";
      savedTrades.forEach((trade) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${trade.date}</td>
          <td>${trade.time}</td>
          <td>${trade.ticker}</td>
          <td><span class="side-badge ${trade.side}">${trade.side.toUpperCase()}</span></td>
          <td>${trade.orderType.toUpperCase()}</td>
          <td>$${trade.price.toFixed(2)}</td>
          <td>${trade.shares}</td>
          <td>$${trade.totalFees.toFixed(2)}</td>
          <td>$${trade.netAmount.toFixed(2)}</td>
        `;
      });
    }

    // ========== CHATBOT ==========
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSendButton = document.getElementById("chatSendButton");

    // Your Cloudflare Worker URL - REPLACE THIS with your actual worker URL
    const WORKER_URL = "https://YOUR-WORKER-NAME.YOUR-USERNAME.workers.dev";

    function showWorkerUrlPrompt() {
      const currentUrl = localStorage.getItem("worker_url") || WORKER_URL;
      const message = `Enter your Cloudflare Worker URL:\n\n(Format: https://your-worker.your-username.workers.dev)\n\nCurrent: ${currentUrl}`;
      
      const url = prompt(message, currentUrl);
      if (url && url.trim()) {
        localStorage.setItem("worker_url", url.trim());
        addChatMessage("‚úÖ Worker URL saved! Try sending a message.", false);
      }
    }

    function getWorkerUrl() {
      return localStorage.getItem("worker_url") || WORKER_URL;
    }

    function addChatMessage(message, isUser = false) {
      const messageDiv = document.createElement("div");
      messageDiv.style.cssText = `
        margin-bottom: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 13px;
        line-height: 1.5;
        ${isUser 
          ? "background: radial-gradient(circle at top left, #2563eb, #1d4ed8); color: #e5f0ff; margin-left: 20%; text-align: right;" 
          : "background: rgba(31, 41, 51, 0.6); color: #e5e7eb; margin-right: 20%;"}
      `;
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendChatMessage() {
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      const workerUrl = getWorkerUrl();
      if (workerUrl.includes("YOUR-WORKER-NAME") || workerUrl.includes("YOUR-USERNAME")) {
        addChatMessage("‚ö†Ô∏è Please set your Cloudflare Worker URL first. Click '‚öôÔ∏è Setup' button.", false);
        return;
      }

      // Add user message
      addChatMessage(userMessage, true);
      chatInput.value = "";
      chatSendButton.disabled = true;
      chatSendButton.textContent = "...";

      // Gather current trade context
      const marginText = marginAmount.textContent.replace(/[$,]/g, "");
      const margin = parseFloat(marginText) || 0;
      
      let tradeContext = "No trade data entered yet.";
      if (currentTradeData && currentTradeData.netAmount > 0) {
        const riskPercent = margin > 0 ? (currentTradeData.netAmount / margin) * 100 : 0;
        tradeContext = `
Current Trade Details:
- Ticker: ${currentTradeData.ticker || 'Not specified'}
- Side: ${currentTradeData.side.toUpperCase()}
- Order Type: ${currentTradeData.orderType.toUpperCase()}
- Trade Price: $${currentTradeData.price.toFixed(2)}
- Shares: ${currentTradeData.shares}
- Gross Amount: $${currentTradeData.grossAmount.toFixed(2)}
- Total Fees: $${currentTradeData.totalFees.toFixed(2)}
- Net Amount (Entry Cost): $${currentTradeData.netAmount.toFixed(2)}
- Portfolio Value: $${(margin / (margin >= 500 ? (new Date().getHours() >= 4 && new Date().getHours() < 16 ? 3 : 2) : 1)).toFixed(2)}
- Margin Amount: $${margin.toFixed(2)}
- Risk Percentage: ${riskPercent.toFixed(1)}%
- ZeroFree Status: ${currentTradeData.isZeroFree ? 'Yes' : 'No'}
`;
      }

      try {
        const response = await fetch(workerUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: userMessage,
            tradeContext: tradeContext
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error("Worker Error:", errorData);
          
          if (response.status === 401) {
            addChatMessage("‚ùå Worker authentication failed. Check your API key in Cloudflare settings.", false);
          } else if (response.status === 429) {
            addChatMessage("‚ö†Ô∏è Rate limit exceeded. Please wait a moment and try again.", false);
          } else {
            addChatMessage(`Error: ${errorData.error || "Unknown error"}`, false);
          }
          chatSendButton.disabled = false;
          chatSendButton.textContent = "Send";
          return;
        }

        const data = await response.json();
        
        if (data.content && data.content[0] && data.content[0].text) {
          addChatMessage(data.content[0].text, false);
        } else if (data.error) {
          addChatMessage(`Error: ${data.error.message || data.error}`, false);
        } else {
          addChatMessage("Sorry, I couldn't process that. Please try again.", false);
        }
      } catch (error) {
        console.error("Chat error:", error);
        if (error.message.includes("Failed to fetch")) {
          addChatMessage("‚ùå Could not connect to worker. Check the URL and try again.", false);
        } else {
          addChatMessage(`Error: ${error.message}`, false);
        }
      }

      chatSendButton.disabled = false;
      chatSendButton.textContent = "Send";
    }

    chatSendButton.addEventListener("click", sendChatMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendChatMessage();
      }
    });

    // ========== PORTFOLIO TAB FUNCTIONS ==========
    function updatePortfolioTab() {
      updateDailyPnL();
      displayOpenPositions();
      displayClosedPositions();
    }

    function updateDailyPnL() {
      const today = new Date().toLocaleDateString("en-US");
      
      // Filter today's closed positions
      const todaysClosed = closedPositions.filter(pos => pos.closeDate === today);
      
      // Calculate total P&L
      let totalPnL = 0;
      let wins = 0;
      let losses = 0;
      
      todaysClosed.forEach(pos => {
        totalPnL += pos.pnl;
        if (pos.pnl > 0) wins++;
        else if (pos.pnl < 0) losses++;
      });

      // Update display
      const pnlEl = document.getElementById("dailyPnL");
      pnlEl.textContent = formatMoney(totalPnL);
      if (totalPnL > 0) {
        pnlEl.style.color = "#4ade80";
      } else if (totalPnL < 0) {
        pnlEl.style.color = "#f97373";
      } else {
        pnlEl.style.color = "var(--muted)";
      }

      document.getElementById("tradesCount").textContent = todaysClosed.length;
      
      const winRate = todaysClosed.length > 0 ? ((wins / todaysClosed.length) * 100).toFixed(0) : 0;
      document.getElementById("winRate").textContent = winRate + "%";
    }

    function displayOpenPositions() {
      const tbody = document.getElementById("openPositionsBody");
      
      if (openPositions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--muted);">No open positions</td></tr>';
        return;
      }

      const marginText = marginAmount.textContent.replace(/[$,]/g, "");
      const margin = parseFloat(marginText) || 1;

      tbody.innerHTML = "";
      openPositions.forEach((pos, index) => {
        const riskPercent = ((pos.netAmount / margin) * 100).toFixed(1);
        
        const row = tbody.insertRow();
        row.innerHTML = `
          <td style="font-weight: 600;">${pos.ticker}</td>
          <td><span class="side-badge ${pos.side}">${pos.side.toUpperCase()}</span></td>
          <td>${pos.shares}</td>
          <td>$${pos.price.toFixed(2)}</td>
          <td>$${pos.netAmount.toFixed(2)}</td>
          <td>${riskPercent}%</td>
          <td>
            <input 
              type="number" 
              step="0.01" 
              min="0" 
              placeholder="Enter price" 
              class="input" 
              id="exitPrice${index}"
              style="width: 100px; padding: 4px 6px; font-size: 12px;"
            />
          </td>
          <td id="pnl${index}" style="font-weight: 600;">--</td>
          <td>
            <button 
              class="btn btn-execute" 
              style="padding: 4px 10px; font-size: 11px;"
              onclick="closePosition(${index})"
            >
              Close
            </button>
          </td>
        `;

        // Add real-time P&L calculation
        document.getElementById(`exitPrice${index}`).addEventListener("input", (e) => {
          calculatePnL(index, parseFloat(e.target.value));
        });
      });
    }

    function calculatePnL(index, exitPrice) {
      const pos = openPositions[index];
      if (!exitPrice || exitPrice <= 0) {
        document.getElementById(`pnl${index}`).textContent = "--";
        return;
      }

      // Calculate exit fees
      let exitFees = 0.02; // TAF
      if (pos.price < 1) {
        exitFees += Math.max(0.99, Math.min(7.95, pos.shares * 0.005));
      } else if (pos.orderType === "market" && pos.shares < 200) {
        exitFees += 0.99;
      } else if (pos.orderType === "market" && pos.shares >= 200) {
        exitFees += pos.shares * 0.005;
      } else if (pos.orderType === "limit" && pos.shares >= 200 && pos.price >= 1) {
        exitFees += 0; // ZeroFree
      } else {
        exitFees += 0.99;
      }

      // Calculate P&L
      let pnl = 0;
      if (pos.side === "long") {
        const proceeds = exitPrice * pos.shares;
        pnl = proceeds - pos.grossAmount - pos.entryFees - exitFees;
      } else {
        // Short
        const proceeds = pos.grossAmount - (exitPrice * pos.shares);
        pnl = proceeds - pos.entryFees - exitFees;
      }

      // Display
      const pnlEl = document.getElementById(`pnl${index}`);
      pnlEl.textContent = formatMoney(pnl);
      pnlEl.style.color = pnl >= 0 ? "#4ade80" : "#f97373";
    }

    window.closePosition = function(index) {
      const exitPriceInput = document.getElementById(`exitPrice${index}`);
      const exitPrice = parseFloat(exitPriceInput.value);

      if (!exitPrice || exitPrice <= 0) {
        alert("Please enter a valid exit price");
        return;
      }

      const pos = openPositions[index];

      // Calculate exit fees
      let exitFees = 0.02; // TAF
      if (pos.price < 1) {
        exitFees += Math.max(0.99, Math.min(7.95, pos.shares * 0.005));
      } else if (pos.orderType === "market" && pos.shares < 200) {
        exitFees += 0.99;
      } else if (pos.orderType === "market" && pos.shares >= 200) {
        exitFees += pos.shares * 0.005;
      } else if (pos.orderType === "limit" && pos.shares >= 200 && pos.price >= 1) {
        exitFees += 0;
      } else {
        exitFees += 0.99;
      }

      // Calculate P&L
      let pnl = 0;
      if (pos.side === "long") {
        const proceeds = exitPrice * pos.shares;
        pnl = proceeds - pos.grossAmount - pos.entryFees - exitFees;
      } else {
        const proceeds = pos.grossAmount - (exitPrice * pos.shares);
        pnl = proceeds - pos.entryFees - exitFees;
      }

      // Create closed position
      const now = new Date();
      const est = toEstDate(now);
      
      const closedPos = {
        ...pos,
        exitPrice,
        exitFees,
        totalFees: pos.entryFees + exitFees,
        pnl,
        closeDate: est.toLocaleDateString("en-US"),
        closeTime: est.toLocaleTimeString("en-US"),
        closeTimestamp: Date.now()
      };

      // Move to closed positions
      closedPositions.push(closedPos);
      localStorage.setItem("closedPositions", JSON.stringify(closedPositions));

      // Add to saved trades for history
      savedTrades.push(closedPos);
      localStorage.setItem("savedTrades", JSON.stringify(savedTrades));

      // Remove from open positions
      openPositions.splice(index, 1);
      localStorage.setItem("openPositions", JSON.stringify(openPositions));

      // Update display
      updatePortfolioTab();
      alert(`Position closed! P&L: ${formatMoney(pnl)}`);
    };

    function displayClosedPositions() {
      const tbody = document.getElementById("closedPositionsBody");
      const today = new Date().toLocaleDateString("en-US");
      
      const todaysClosed = closedPositions.filter(pos => pos.closeDate === today);

      if (todaysClosed.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--muted);">No closed positions today</td></tr>';
        return;
      }

      tbody.innerHTML = "";
      todaysClosed.forEach(pos => {
        const row = tbody.insertRow();
        const pnlColor = pos.pnl >= 0 ? "#4ade80" : "#f97373";
        
        row.innerHTML = `
          <td>${pos.closeTime}</td>
          <td style="font-weight: 600;">${pos.ticker}</td>
          <td><span class="side-badge ${pos.side}">${pos.side.toUpperCase()}</span></td>
          <td>${pos.shares}</td>
          <td>$${pos.price.toFixed(2)}</td>
          <td>$${pos.exitPrice.toFixed(2)}</td>
          <td>$${pos.totalFees.toFixed(2)}</td>
          <td style="font-weight: 600; color: ${pnlColor};">${formatMoney(pos.pnl)}</td>
        `;
      });
    }

    // Reset daily data at midnight
    function checkDailyReset() {
      const lastReset = localStorage.getItem("lastReset");
      const today = new Date().toLocaleDateString("en-US");

      if (lastReset !== today) {
        // Don't delete closed positions, just update lastReset
        localStorage.setItem("lastReset", today);
      }
    }

    // ========== INIT ==========
    updateLocateVisibility();
    calculate();
    displaySavedTrades();
    checkDailyReset();
    updatePortfolioTab();
  </script>
</body>
</html>
