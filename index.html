<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading Control Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #070b12;
      --card: #101623;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --border: #1f2933;
      --input: #0b111c;
      --green: #22c55e;
      --yellow: #fbbf24;
      --red: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 60%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 8px;
    }

    .app-container {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
      padding: 20px 24px 28px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-line {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .portfolio-block {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .portfolio-label {
      color: var(--muted);
    }

    .portfolio-input {
      min-width: 120px;
      padding: 6px 9px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: var(--input);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .portfolio-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
    }

    .margin-text {
      font-size: 14px;
      color: var(--muted);
    }

    .margin-value {
      color: var(--text);
      font-weight: 500;
      margin-left: 4px;
    }

    .clock-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .clock-line {
      font-size: 14px;
      font-weight: 500;
    }

    .status-pill {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-pre {
      background: rgba(245, 158, 11, 0.1);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .status-open {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }

    .status-after {
      background: rgba(96, 165, 250, 0.14);
      color: #93c5fd;
      border: 1px solid rgba(96, 165, 250, 0.5);
    }

    .status-closed {
      background: rgba(148, 163, 184, 0.06);
      color: #cbd5f5;
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.7);
      padding: 3px;
      margin-bottom: 16px;
      width: fit-content;
    }

    .tab-button {
      border: none;
      padding: 6px 16px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 999px;
      background: transparent;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .tab-button.active {
      background: radial-gradient(circle at top left, #2563eb, #1d4ed8);
      color: #e5f0ff;
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.4), 0 6px 14px rgba(37, 99, 235, 0.45);
    }

    .tab-icon {
      font-size: 15px;
    }

    .content {
      margin-top: 6px;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.6);
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
    }

    .card-note {
      font-size: 11px;
      color: var(--muted);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 22px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
    }

    .input, .select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: var(--input);
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.12s ease;
    }

    .input:focus, .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45);
    }

    .input::placeholder {
      color: #6b7280;
    }

    .locate-hidden {
      display: none;
    }

    .section-divider {
      border: none;
      border-top: 1px dashed rgba(55, 65, 81, 0.8);
      margin: 14px 0 10px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 16px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .summary-item {
      font-size: 13px;
      color: var(--muted);
    }

    .summary-item span {
      color: var(--text);
      font-weight: 500;
    }

    .summary-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    .summary-badge.free {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.16);
    }

    .summary-badge.paid {
      border-color: rgba(239, 68, 68, 0.7);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.16);
    }

    .fees-card {
      margin-top: 2px;
      background: linear-gradient(135deg, #020617, #020617);
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 12px 12px 10px;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .fees-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .fees-title {
      font-size: 13px;
      font-weight: 600;
    }

    .fees-body {
      font-size: 12px;
      color: var(--muted);
    }

    .fee-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }

    .fee-name {
      color: #9ca3af;
    }

    .fee-value {
      color: #e5e7eb;
      font-variant-numeric: tabular-nums;
    }

    .fee-total {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(75, 85, 99, 0.9);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    .fee-total-label {
      color: #e5e7eb;
    }

    .fee-total-value {
      color: #fbbf24;
    }

    .net-row {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
    }

    .net-label {
      color: #e5e7eb;
    }

    .net-value {
      color: #93c5fd;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.2s ease;
    }

    .btn-execute {
      background: radial-gradient(circle at top left, #2563eb, #1d4ed8);
      color: #e5f0ff;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.65);
    }

    .btn-execute:hover {
      background: radial-gradient(circle at top left, #16a34a, #15803d);
      box-shadow: 0 6px 18px rgba(22, 163, 74, 0.75);
      transform: translateY(-1px);
    }

    .btn-cancel {
      background: transparent;
      color: var(--muted);
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .btn-cancel:hover {
      border-color: rgba(239, 68, 68, 0.9);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-1px);
    }

    .status-text {
      font-size: 12px;
      margin-top: 6px;
      color: var(--muted);
    }

    .status-text span {
      color: #e5e7eb;
    }

    .risk-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.7fr);
      gap: 20px;
    }

    .gauge-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .gauge-label {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }

    .gauge-status {
      font-size: 15px;
      font-weight: 600;
    }

    .gauge-status.green {
      color: var(--green);
    }

    .gauge-status.yellow {
      color: var(--yellow);
    }

    .gauge-status.red {
      color: var(--red);
    }

    .gauge-description {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      max-width: 280px;
    }

    .targets-card {
      font-size: 12px;
    }

    .targets-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }

    .targets-table th,
    .targets-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #111827;
      text-align: left;
    }

    .targets-table th {
      color: var(--muted);
      font-weight: 500;
    }

    .targets-table td {
      color: #e5e7eb;
    }

    .targets-profit-bad {
      color: var(--red);
    }

    .targets-profit-good {
      color: var(--green);
    }

    .risk-meta-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      font-size: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .risk-meta-item {
      color: var(--muted);
    }

    .risk-meta-item strong {
      color: var(--text);
    }

    .saved-table-wrapper {
      max-height: 320px;
      overflow-y: auto;
      font-size: 12px;
    }

    .saved-table {
      width: 100%;
      border-collapse: collapse;
    }

    .saved-table th,
    .saved-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #111827;
    }

    .saved-table th {
      text-align: left;
      color: var(--muted);
      font-weight: 500;
      position: sticky;
      top: 0;
      background: #020617;
    }

    .saved-table td {
      color: #e5e7eb;
      font-size: 11px;
    }

    @media (max-width: 900px) {
      .risk-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .app-container {
        padding: 16px 14px 22px;
      }
      .header-row {
        align-items: flex-start;
      }
      .clock-block {
        align-items: flex-start;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
      .tabs {
        width: 100%;
      }
      .actions-row {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header-row">
      <div class="title-block">
        <div class="title-line">
          <div class="title">Trading Control Center</div>
          <div class="portfolio-block">
            <span class="portfolio-label">Portfolio:</span>
            <input
              id="portfolioInput"
              class="portfolio-input"
              type="number"
              step="0.01"
              min="0"
              placeholder="e.g. 5000"
            />
            <span class="margin-text">
              Margin Amount:
              <span id="marginAmount" class="margin-value">$0.00</span>
            </span>
          </div>
        </div>
        <div class="subtitle">
          Fee Structure &amp; Risk Management &bull; TradeZero-style fee model
        </div>
      </div>
      <div class="clock-block">
        <div class="clock-line" id="clockDisplay">--/--/---- --:-- -- EST</div>
        <div id="marketStatusPill" class="status-pill status-closed">
          <span id="marketStatusText">Market Closed</span>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-tab="fees">
        <span class="tab-icon">üìä</span>
        Fee Structure
      </button>
      <button class="tab-button" data-tab="risk">
        <span class="tab-icon">üõ°Ô∏è</span>
        Risk Management
      </button>
      <button class="tab-button" data-tab="saved">
        <span class="tab-icon">üíæ</span>
        Saved Trades
      </button>
    </div>

    <div class="content">
      <!-- FEE STRUCTURE TAB -->
      <div class="tab-panel active" id="tab-fees">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Order Inputs</div>
            <div class="card-note">
              Fill in symbol, side, price, shares, and locate fee (if short).
            </div>
          </div>

          <div class="grid-2">
            <div class="field">
              <label for="symbolInput">Ticker Symbol</label>
              <input
                id="symbolInput"
                class="input"
                type="text"
                placeholder="e.g. VERO"
              />
            </div>

            <div class="field">
              <label for="orderType">Order Type</label>
              <select id="orderType" class="select">
                <option value="limit">Limit</option>
                <option value="market">Market</option>
              </select>
            </div>

            <div class="field">
              <label for="side">Side</label>
              <select id="side" class="select">
                <option value="long">Long</option>
                <option value="short">Short</option>
              </select>
            </div>

            <div class="field">
              <label for="tradePrice">Trade Price (per share, USD)</label>
              <input
                id="tradePrice"
                class="input"
                type="number"
                step="0.01"
                min="0"
                placeholder="e.g. 10.00"
              />
            </div>

            <div class="field">
              <label for="shares">Shares</label>
              <input
                id="shares"
                class="input"
                type="number"
                step="1"
                min="0"
                placeholder="e.g. 100"
              />
            </div>

            <div class="field" id="locateField">
              <label for="locatePrice">Locate Fee (USD, for shorts)</label>
              <input
                id="locatePrice"
                class="input"
                type="number"
                step="0.01"
                min="0"
                placeholder="e.g. 1.12"
              />
            </div>
          </div>

          <hr class="section-divider" />

          <div class="summary-row">
            <div class="summary-item">
              Order:
              <span id="summaryOrder">--</span>
            </div>
            <div class="summary-item">
              Gross Amount:
              <span id="summaryNotional">$0.00</span>
            </div>
            <div class="summary-item">
              ZeroFree Status:
              <span id="summaryZeroFree">--</span>
            </div>
            <div>
              <span id="summaryBadge" class="summary-badge">
                Waiting for input
              </span>
            </div>
          </div>

          <div class="fees-card">
            <div class="fees-header">
              <div class="fees-title">Fee Breakdown</div>
              <div class="fees-body" style="font-size: 11px;">
                TradeZero commission structure with regulatory fees.
              </div>
            </div>
            <div class="fees-body" id="feesBody">
              <div class="fee-row">
                <div class="fee-name">Commission</div>
                <div class="fee-value" id="feeCommission">$0.00</div>
              </div>
              <div class="fee-row">
                <div class="fee-name">TAF</div>
                <div class="fee-value" id="feeTAF">$0.00</div>
              </div>
              <div class="fee-row">
                <div class="fee-name">Locate Fee</div>
                <div class="fee-value" id="feeLocate">$0.00</div>
              </div>

              <div class="fee-total">
                <div class="fee-total-label">Total Fees</div>
                <div class="fee-total-value" id="feeTotal">$0.00</div>
              </div>

              <div class="net-row">
                <div class="net-label">Net Amount (entry cost)</div>
                <div class="net-value" id="netAmount">$0.00</div>
              </div>
            </div>
          </div>

          <div class="status-text">
            Status:
            <span id="statusMessage">
              Waiting for inputs. Fill out price and shares to calculate fees.
            </span>
          </div>

          <div class="actions-row">
            <button class="btn btn-execute" id="executeButton">
              ‚úÖ Execute Trade
            </button>
            <button class="btn btn-cancel" id="cancelButton">
              ‚úñ Cancel Trade
            </button>
          </div>
        </div>
      </div>

      <!-- RISK MANAGEMENT TAB -->
      <div class="tab-panel" id="tab-risk">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Risk Management</div>
            <div class="card-note">
              Position risk analysis based on your margin and fees.
            </div>
          </div>

          <div class="risk-layout">
            <div class="gauge-container">
              <svg id="riskGauge" width="240" height="240" viewBox="0 0 240 240">
                <!-- Background circle -->
                <circle cx="120" cy="120" r="90" fill="none" stroke="#0b1120" stroke-width="28"></circle>
                
                <!-- Green zone (0-34%) -->
                <circle cx="120" cy="120" r="90" fill="none" stroke="#22c55e" stroke-width="28" 
                        stroke-linecap="round" stroke-dasharray="192 565" 
                        transform="rotate(-90 120 120)" id="arcGreen"></circle>
                
                <!-- Yellow zone (35-66%) -->
                <circle cx="120" cy="120" r="90" fill="none" stroke="#fbbf24" stroke-width="28" 
                        stroke-linecap="round" stroke-dasharray="180 565" 
                        stroke-dashoffset="-192"
                        transform="rotate(-90 120 120)" id="arcYellow"></circle>
                
                <!-- Red zone (67-100%) -->
                <circle cx="120" cy="120" r="90" fill="none" stroke="#f97373" stroke-width="28" 
                        stroke-linecap="round" stroke-dasharray="192 565" 
                        stroke-dashoffset="-372"
                        transform="rotate(-90 120 120)" id="arcRed"></circle>

                <!-- Center fill -->
                <circle cx="120" cy="120" r="64" fill="#020617"></circle>

                <!-- Needle -->
                <line id="gaugeNeedle" x1="120" y1="120" x2="120" y2="34" 
                      stroke="#e5e7eb" stroke-width="3" stroke-linecap="round"
                      transform="rotate(0 120 120)"></line>

                <!-- Center dot -->
                <circle cx="120" cy="120" r="5" fill="#e5e7eb"></circle>

                <!-- Percentage text -->
                <text id="gaugePercentText" x="120" y="128" text-anchor="middle" 
                      fill="#e5e7eb" font-size="18" font-weight="600">0%</text>
              </svg>

              <div class="gauge-label">
                Risk usage: Net Amount √∑ Margin Amount
              </div>
              <div id="gaugeStatusText" class="gauge-status green">
                Acceptable / Controlled Risk
              </div>
              <div id="gaugeDescription" class="gauge-description">
                Enter portfolio value and order details to see position risk.
              </div>
            </div>

            <div class="targets-card">
              <div class="risk-meta-row">
                <div class="risk-meta-item">
                  <span>Margin Portfolio:</span>
                  <strong id="riskMargin">$0.00</strong>
                </div>
                <div class="risk-meta-item">
                  <span>Risked Amount (Net):</span>
                  <strong id="riskNetUsed">$0.00</strong>
                </div>
                <div class="risk-meta-item">
                  <span>Side:</span>
                  <strong id="riskSideLabel">--</strong>
                </div>
              </div>

              <div class="card-note" style="margin-bottom: 6px;">
                Profit Targets (price movement needed after fees)
              </div>

              <table class="targets-table">
                <thead>
                  <tr>
                    <th>Percent Range</th>
                    <th>Dollar Range</th>
                  </tr>
                </thead>
                <tbody id="targetsBody">
                  <tr>
                    <td colspan="2" style="text-align: center; color: var(--muted);">
                      No trade data yet
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- SAVED TRADES TAB -->
      <div class="tab-panel" id="tab-saved">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Saved Trades (Browser Log)</div>
            <div class="card-note">
              Stored locally in your browser. Clearing browser data will erase this log.
            </div>
          </div>

          <div class="saved-table-wrapper">
            <table class="saved-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Type</th>
                  <th style="text-align:right;">Price</th>
                  <th style="text-align:right;">Shares</th>
                  <th style="text-align:right;">Fees</th>
                  <th style="text-align:right;">Net</th>
                </tr>
              </thead>
              <tbody id="savedBody">
                <tr>
                  <td colspan="9" style="text-align: center; color: var(--muted); padding: 20px;">
                    No saved trades yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== UTILITIES ==========
    function formatMoney(value) {
      if (!isFinite(value)) return "$0.00";
      return "$" + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function parseMoney(text) {
      if (!text) return 0;
      return parseFloat(String(text).replace(/[^0-9.-]/g, "")) || 0;
    }

    function toEstDate(date) {
      const utc = date.getTime() + date.getTimezoneOffset() * 60000;
      const estOffsetHours = -5;
      return new Date(utc + estOffsetHours * 3600000);
    }

    // ========== GLOBAL STATE ==========
    let portfolioValue = 0;
    let lastNotional = 0;
    let lastTotalFees = 0;
    let lastNet = 0;
    let lastSide = "long";

    function getMarketStatus(estDate) {
      const day = estDate.getDay();
      const hours = estDate.getHours();
      const minutes = estDate.getMinutes();
      const totalMinutes = hours * 60 + minutes;

      if (day === 0 || day === 6) {
        return { status: "Market Closed", class: "status-closed" };
      }

      const preStart = 4 * 60;
      const preEnd = 9 * 60;
      const openStart = 9 * 60;
      const openEnd = 16 * 60;
      const afterStart = 16 * 60;
      const afterEnd = 20 * 60;

      if (totalMinutes >= preStart && totalMinutes < preEnd) {
        return { status: "Pre-Market", class: "status-pre" };
      }
      if (totalMinutes >= openStart && totalMinutes < openEnd) {
        return { status: "Market Hours", class: "status-open" };
      }
      if (totalMinutes >= afterStart && totalMinutes < afterEnd) {
        return { status: "After Market Hours", class: "status-after" };
      }
      return { status: "Market Closed", class: "status-closed" };
    }

    function getCurrentLeverage(estDate, portfolioValue) {
      if (portfolioValue < 500) {
        return 1;
      }
      const hours = estDate.getHours();
      const minutes = estDate.getMinutes();
      const totalMinutes = hours * 60 + minutes;

      const intradayStart = 4 * 60;
      const intradayEnd = 16 * 60;
      const afterStart = 16 * 60;
      const afterEnd = 20 * 60;

      if (totalMinutes >= intradayStart && totalMinutes < intradayEnd) {
        return 3;
      }
      if (totalMinutes >= afterStart && totalMinutes < afterEnd) {
        return 2;
      }
      return 2;
    }

    // ========== CLOCK + PORTFOLIO ==========
    const clockDisplay = document.getElementById("clockDisplay");
    const marketStatusPill = document.getElementById("marketStatusPill");
    const marketStatusText = document.getElementById("marketStatusText");
    const marginAmountEl = document.getElementById("marginAmount");
    const portfolioInput = document.getElementById("portfolioInput");

    function updateMargin(est) {
      const lev = getCurrentLeverage(est, portfolioValue);
      const marginValue = portfolioValue * lev;
      marginAmountEl.textContent = formatMoney(marginValue);
      // Only update risk gauge if elements are initialized
      if (typeof updateRiskGauge === 'function') {
        updateRiskGauge();
      }
    }

    function updateClock() {
      const now = new Date();
      const est = toEstDate(now);

      const month = String(est.getMonth() + 1).padStart(2, "0");
      const day = String(est.getDate()).padStart(2, "0");
      const year = est.getFullYear();
      let hours = est.getHours();
      let minutes = String(est.getMinutes()).padStart(2, "0");
      let ampm = hours >= 12 ? "PM" : "AM";
      let displayHour = hours % 12;
      if (displayHour === 0) displayHour = 12;

      clockDisplay.textContent =
        month + "/" + day + "/" + year + " " + displayHour + ":" + minutes + " " + ampm + " EST";

      const status = getMarketStatus(est);
      marketStatusPill.className = "status-pill " + status.class;
      marketStatusText.textContent = status.status;

      updateMargin(est);
    }

    setInterval(updateClock, 1000);
    updateClock();

    portfolioInput.addEventListener("input", () => {
      portfolioValue = parseFloat(portfolioInput.value) || 0;
      const now = new Date();
      updateMargin(toEstDate(now));
    });

    // ========== TABS ==========
    const tabButtons = document.querySelectorAll(".tab-button");
    const tabPanels = {
      fees: document.getElementById("tab-fees"),
      risk: document.getElementById("tab-risk"),
      saved: document.getElementById("tab-saved"),
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        tabButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        Object.keys(tabPanels).forEach((key) => {
          tabPanels[key].classList.toggle("active", key === tab);
        });
      });
    });

    // ========== ELEMENTS ==========
    const symbolInput = document.getElementById("symbolInput");
    const orderTypeSelect = document.getElementById("orderType");
    const sideSelect = document.getElementById("side");
    const tradePriceInput = document.getElementById("tradePrice");
    const sharesInput = document.getElementById("shares");
    const locatePriceInput = document.getElementById("locatePrice");

    const summaryOrder = document.getElementById("summaryOrder");
    const summaryNotional = document.getElementById("summaryNotional");
    const summaryZeroFree = document.getElementById("summaryZeroFree");
    const summaryBadge = document.getElementById("summaryBadge");

    const feeCommission = document.getElementById("feeCommission");
    const feeTAF = document.getElementById("feeTAF");
    const feeLocate = document.getElementById("feeLocate");
    const feeTotal = document.getElementById("feeTotal");
    const netAmount = document.getElementById("netAmount");
    const statusMessage = document.getElementById("statusMessage");

    const executeButton = document.getElementById("executeButton");
    const cancelButton = document.getElementById("cancelButton");

    const riskNetUsedEl = document.getElementById("riskNetUsed");
    const riskSideLabel = document.getElementById("riskSideLabel");
    const riskMarginEl = document.getElementById("riskMargin");
    const targetsBody = document.getElementById("targetsBody");

    const savedBody = document.getElementById("savedBody");

    const gaugeNeedle = document.getElementById("gaugeNeedle");
    const gaugePercentText = document.getElementById("gaugePercentText");
    const gaugeStatusText = document.getElementById("gaugeStatusText");
    const gaugeDescription = document.getElementById("gaugeDescription");
    function calculate() {
    function calculate() {
      const symbol = symbolInput.value.trim().toUpperCase();
      const orderType = orderTypeSelect.value;
      const side = sideSelect.value;
      const price = parseFloat(tradePriceInput.value);
      const shares = parseInt(sharesInput.value, 10);
      const locate = parseFloat(locatePriceInput.value) || 0;

      if (!symbol && (!shares || !price)) {
        summaryOrder.textContent = "--";
      } else {
        summaryOrder.textContent =
          (side === "short" ? "Short " : "Long ") +
          (shares || 0) +
          " " +
          (symbol || "SYMBOL") +
          " @ " +
          (isFinite(price) ? "$" + price.toFixed(2) : "--") +
          " (" +
          (orderType === "limit" ? "Limit" : "Market") +
          ")";
      }

      let notional = 0;
      if (isFinite(price) && isFinite(shares) && shares > 0) {
        notional = price * shares;
      }
      summaryNotional.textContent = formatMoney(notional);

      if (!isFinite(price) || !isFinite(shares) || shares <= 0 || price <= 0) {
        feeCommission.textContent = "$0.00";
        feeTAF.textContent = "$0.00";
        feeLocate.textContent = formatMoney(locate);
        feeTotal.textContent = formatMoney(locate);
        netAmount.textContent = formatMoney(notional + locate);
        summaryZeroFree.textContent = "--";
        summaryBadge.className = "summary-badge";
        summaryBadge.textContent = "Waiting for input";
        statusMessage.textContent = "Enter price and shares to calculate fees.";
        updateRiskSection(notional, locate, notional + locate, side);
        return;
      }

      let isZeroFree = false;
      if (orderType === "limit" && shares >= 200 && price >= 1) {
        isZeroFree = true;
      }

      let commission = 0;
      if (isZeroFree) {
        commission = 0;
      } else {
        if (shares < 200) {
          commission = 0.99;
        } else {
          commission = shares * 0.005;
        }
      }

      let taf = 0.02;

      const locateFee = side === "short" ? locate : 0;

      const totalFees = commission + taf + locateFee;
      const net = notional + totalFees;

      feeCommission.textContent = formatMoney(commission);
      feeTAF.textContent = formatMoney(taf);
      feeLocate.textContent = formatMoney(locateFee);
      feeTotal.textContent = formatMoney(totalFees);
      netAmount.textContent = formatMoney(net);

      summaryZeroFree.textContent = isZeroFree ? "Qualifies (ZeroFree)" : "Paid commission";

      if (isZeroFree) {
        summaryBadge.className = "summary-badge free";
        summaryBadge.textContent = "ZeroFree Trade";
        statusMessage.textContent =
          "This order meets ZeroFree conditions: Limit, ‚â•200 shares, price ‚â•$1. Commission is $0.00.";
      } else {
        summaryBadge.className = "summary-badge paid";
        summaryBadge.textContent = "Commission Charged";
        statusMessage.textContent =
          "This order does not meet ZeroFree rules. Commission and fees apply.";
      }

      updateRiskSection(notional, totalFees, net, side);
    }

    // ========== RISK SECTION UPDATE ==========

    // ========== RISK SECTION UPDATE ==========
    function updateRiskSection(notional, totalFees, net, side) {
      const margin = parseMoney(marginAmountEl.textContent);

      // Store values for later use
      lastNotional = notional;
      lastTotalFees = totalFees;
      lastNet = net;
      lastSide = side;

      riskSideLabel.textContent = side ? side.toUpperCase() : "--";
      riskNetUsedEl.textContent = formatMoney(net || 0);
      riskMarginEl.textContent = formatMoney(margin || 0);

      updateRiskGauge();
      updateProfitTargets(notional, totalFees, side);
    }

    // ========== RISK GAUGE ==========
    function updateRiskGauge() {
      const margin = parseMoney(marginAmountEl.textContent);
      const net = lastNet;

      let pct = 0;
      if (margin > 0 && net > 0) {
        pct = Math.min((net / margin) * 100, 100);
      }

      const angle = (pct / 100) * 360;
      gaugeNeedle.setAttribute("transform", `rotate(${angle} 120 120)`);
      gaugePercentText.textContent = Math.round(pct) + "%";

      let zone = "green";
      let statusText = "Acceptable / Controlled Risk";
      let desc = "Position size is within your defined risk range.";

      if (pct >= 35 && pct <= 66) {
        zone = "yellow";
        statusText = "Elevated / Watch Carefully";
        desc = "You are using a meaningful portion of available margin. Review if this aligns with your risk plan.";
      } else if (pct > 66) {
        zone = "red";
        statusText = "High / Excessive Risk";
        desc = "Position size exceeds your preferred risk; Cut down position size.";
      }

      gaugeStatusText.className = "gauge-status " + zone;
      gaugeStatusText.textContent = statusText;
      gaugeDescription.textContent = desc;
    }

    // ========== PROFIT TARGETS ==========
    function updateProfitTargets(notional, totalFees, side) {
      targetsBody.innerHTML = "";

      if (!notional || notional <= 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 2;
        td.style.textAlign = "center";
        td.style.color = "var(--muted)";
        td.textContent = "No trade data yet";
        tr.appendChild(td);
        targetsBody.appendChild(tr);
        return;
      }

      const feeDollars = totalFees || 0;
      const feePctRaw = notional > 0 ? (feeDollars / notional) * 100 : 0;

      function row(percentRange, dollarRange, isBad) {
        const tr = document.createElement("tr");
        const tdP = document.createElement("td");
        const tdD = document.createElement("td");
        tdP.textContent = percentRange;
        tdD.textContent = dollarRange;
        tdD.className = isBad ? "targets-profit-bad" : "targets-profit-good";
        tr.appendChild(tdP);
        tr.appendChild(tdD);
        targetsBody.appendChild(tr);
      }

      // First row: exact fee percentage (not rounded)
      const feePctDisplay = Math.round(feePctRaw * 100) / 100;
      const low1Pct = 0;
      const high1Pct = feePctDisplay;
      const low1Dol = 0;
      const high1Dol = (high1Pct / 100) * notional;

      row(
        `${low1Pct.toFixed(2)}% ‚Äì ${high1Pct.toFixed(2)}%`,
        `${formatMoney(low1Dol)} ‚Äì ${formatMoney(high1Dol)}`,
        true
      );

      // Remaining 5 rows: round up to nearest 5%, then increment by 5%
      let baseBucket = Math.ceil(feePctRaw / 5) * 5;
      if (baseBucket === 0) baseBucket = 5;

      let startPct = baseBucket;
      for (let i = 0; i < 5; i++) {
        const endPct = startPct + 5;
        const lowDol = (startPct / 100) * notional;
        const highDol = (endPct / 100) * notional;
        row(
          `${startPct.toFixed(0)}% ‚Äì ${endPct.toFixed(0)}%`,
          `${formatMoney(lowDol)} ‚Äì ${formatMoney(highDol)}`,
          false
        );
        startPct = endPct;
      }
    }

    // ========== LOCAL STORAGE ==========
    const LOG_KEY = "tz_trading_control_trades";

    function loadTrades() {
      try {
        const raw = localStorage.getItem(LOG_KEY);
        if (!raw) return [];
        return JSON.parse(raw) || [];
      } catch (e) {
        console.error("Error reading trades", e);
        return [];
      }
    }

    function saveTrades(trades) {
      try {
        localStorage.setItem(LOG_KEY, JSON.stringify(trades));
      } catch (e) {
        console.error("Error saving trades", e);
      }
    }

    function appendSavedTradeRow(trade) {
      if (savedBody.children.length === 1 && savedBody.children[0].children.length === 1) {
        savedBody.innerHTML = "";
      }

      const tr = document.createElement("tr");

      function cell(text, alignRight) {
        const td = document.createElement("td");
        td.textContent = text;
        if (alignRight) td.style.textAlign = "right";
        return td;
      }

      tr.appendChild(cell(trade.date));
      tr.appendChild(cell(trade.time));
      tr.appendChild(cell(trade.symbol));
      tr.appendChild(cell(trade.side.toUpperCase()));
      tr.appendChild(cell(trade.orderType.toUpperCase()));
      tr.appendChild(cell(formatMoney(trade.tradePrice), true));
      tr.appendChild(cell(trade.shares, true));
      tr.appendChild(cell(formatMoney(trade.totalFees), true));
      tr.appendChild(cell(formatMoney(trade.netAmount), true));

      savedBody.appendChild(tr);
    }

    function renderSavedTrades() {
      savedBody.innerHTML = "";
      const trades = loadTrades();
      if (trades.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 9;
        td.style.textAlign = "center";
        td.style.color = "var(--muted)";
        td.style.padding = "20px";
        td.textContent = "No saved trades yet";
        tr.appendChild(td);
        savedBody.appendChild(tr);
      } else {
        trades.forEach(appendSavedTradeRow);
      }
    }

    function buildTradePayload() {
      const now = new Date();
      const est = toEstDate(now);
      
      const month = String(est.getMonth() + 1).padStart(2, "0");
      const day = String(est.getDate()).padStart(2, "0");
      const year = est.getFullYear();
      let hours = est.getHours();
      const minutes = String(est.getMinutes()).padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      let displayHour = hours % 12;
      if (displayHour === 0) displayHour = 12;

      const dateStr = month + "/" + day + "/" + year;
      const timeStr = displayHour + ":" + minutes + " " + ampm;

      return {
        date: dateStr,
        time: timeStr,
        symbol: symbolInput.value.trim().toUpperCase(),
        orderType: orderTypeSelect.value,
        side: sideSelect.value,
        tradePrice: parseFloat(tradePriceInput.value) || 0,
        shares: parseInt(sharesInput.value, 10) || 0,
        locatePrice: parseFloat(locatePriceInput.value) || 0,
        commission: parseMoney(feeCommission.textContent),
        taf: parseMoney(feeTAF.textContent),
        totalFees: parseMoney(feeTotal.textContent),
        netAmount: parseMoney(netAmount.textContent),
      };
    }

    // ========== CLEAR ORDER INPUTS ==========
    function clearOrderInputs() {
      symbolInput.value = "";
      orderTypeSelect.value = "limit";
      sideSelect.value = "long";
      tradePriceInput.value = "";
      sharesInput.value = "";
      locatePriceInput.value = "";
      calculate();
    }

    // ========== EVENT LISTENERS ==========
    orderTypeSelect.addEventListener("change", calculate);
    sideSelect.addEventListener("change", calculate);
    symbolInput.addEventListener("input", calculate);
    tradePriceInput.addEventListener("input", calculate);
    sharesInput.addEventListener("input", calculate);
    locatePriceInput.addEventListener("input", calculate);

    executeButton.addEventListener("click", () => {
      calculate();

      const payload = buildTradePayload();

      if (!payload.symbol || !payload.shares || !payload.tradePrice) {
        alert("Please enter symbol, price, and shares before executing.");
        return;
      }

      const trades = loadTrades();
      trades.push(payload);
      saveTrades(trades);
      appendSavedTradeRow(payload);

      clearOrderInputs();
      alert("Trade executed and saved to browser log.");
    });

    cancelButton.addEventListener("click", () => {
      clearOrderInputs();
    });

    // ========== INIT ==========
    calculate();
    renderSavedTrades();
  </script>
</body>
</html>
