<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trading Control Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #070b12;
      --card: #101623;
      --accent: #3b82f6;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2933;
      --input: #0b111c;
      --green: #22c55e;
      --yellow: #fbbf24;
      --red: #f97373;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { background: radial-gradient(circle at top, #111827 0, #020617 60%); color: var(--text); min-height: 100vh; display: flex; justify-content: center; padding: 32px 8px; }
    .app-container { width: 100%; max-width: 1100px; background: #020617; border-radius: 16px; border: 1px solid #1f2937; box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9); padding: 20px 24px 28px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; gap: 16px; flex-wrap: wrap; }
    .title-block { display: flex; flex-direction: column; gap: 6px; }
    .title-line { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .title { font-size: 20px; font-weight: 600; }
    .subtitle { font-size: 12px; color: var(--muted); }
    .portfolio-block { display: flex; align-items: center; gap: 10px; font-size: 14px; }
    .portfolio-label { color: var(--muted); }
    .portfolio-input { min-width: 120px; padding: 6px 9px; border-radius: 8px; border: 1px solid #1f2937; background: var(--input); color: var(--text); font-size: 14px; outline: none; }
    .portfolio-input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45); }
    .margin-text { font-size: 14px; color: var(--muted); }
    .margin-value { color: var(--text); font-weight: 500; margin-left: 4px; }
    .clock-block { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .clock-line { font-size: 14px; font-weight: 500; }
    .status-pill { padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-pre { background: rgba(245, 158, 11, 0.1); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.4); }
    .status-open { background: rgba(34, 197, 94, 0.12); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.5); }
    .status-after { background: rgba(96, 165, 250, 0.14); color: #93c5fd; border: 1px solid rgba(96, 165, 250, 0.5); }
    .status-closed { background: rgba(148, 163, 184, 0.06); color: #cbd5f5; border: 1px solid rgba(148, 163, 184, 0.5); }
    .tabs { display: flex; border-radius: 999px; background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(55, 65, 81, 0.7); padding: 3px; margin-bottom: 16px; width: fit-content; }
    .tab-button { border: none; padding: 6px 16px; font-size: 13px; cursor: pointer; border-radius: 999px; background: transparent; color: var(--muted); display: flex; align-items: center; gap: 6px; transition: 0.15s ease; }
    .tab-button.active { background: radial-gradient(circle at top left, #2563eb, #1d4ed8); color: #e5f0ff; box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.4), 0 6px 14px rgba(37, 99, 235, 0.45); }
    .tab-icon { font-size: 15px; }
    .content { margin-top: 6px; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .card { background: #020617; border-radius: 14px; border: 1px solid var(--border); padding: 18px; box-shadow: 0 14px 40px rgba(15, 23, 42, 0.6); }
    .card-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .card-title { font-size: 15px; font-weight: 600; }
    .card-note { font-size: 11px; color: var(--muted); }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px 22px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 12px; color: var(--muted); }
    .input, .select { width: 100%; padding: 7px 9px; border-radius: 8px; border: 1px solid #1f2937; background: var(--input); color: var(--text); font-size: 13px; outline: none; }
    .input:focus, .select:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.45); }
    .input::placeholder { color: #6b7280; }
    .section-divider { border: none; border-top: 1px dashed rgba(55, 65, 81, 0.8); margin: 14px 0 10px; }
    .summary-row { display: flex; justify-content: space-between; align-items: baseline; gap: 16px; margin-bottom: 10px; flex-wrap: wrap; }
    .summary-item { font-size: 13px; color: var(--muted); }
    .summary-item span { color: var(--text); font-weight: 500; }
    .summary-badge { font-size: 11px; padding: 3px 10px; border-radius: 999px; text-transform: uppercase; border: 1px solid rgba(148, 163, 184, 0.7); color: #e5e7eb; }
    .summary-badge.free { border-color: rgba(34, 197, 94, 0.7); color: #bbf7d0; background: rgba(22, 163, 74, 0.16); }
    .summary-badge.paid { border-color: rgba(239, 68, 68, 0.7); color: #fecaca; background: rgba(239, 68, 68, 0.16); }
    .fees-card { margin-top: 2px; background: #020617; border-radius: 12px; border: 1px solid #1f2937; padding: 12px; }
    .fees-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .fees-title { font-size: 13px; font-weight: 600; }
    .fees-body { font-size: 12px; color: var(--muted); }
    .fee-row { display: flex; justify-content: space-between; padding: 3px 0; }
    .fee-name { color: #9ca3af; }
    .fee-value { color: #e5e7eb; }
    .fee-total { margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(75, 85, 99, 0.9); display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; }
    .fee-total-label { color: #e5e7eb; }
    .fee-total-value { color: #fbbf24; }
    .net-row { margin-top: 4px; display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; }
    .net-label { color: #e5e7eb; }
    .net-value { color: #93c5fd; }
    .actions-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
    .btn { border: none; border-radius: 999px; padding: 8px 16px; font-size: 12px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s ease; }
    .btn-execute { background: radial-gradient(circle at top left, #2563eb, #1d4ed8); color: #e5f0ff; box-shadow: 0 6px 16px rgba(37, 99, 235, 0.65); }
    .btn-execute:hover { background: radial-gradient(circle at top left, #16a34a, #15803d); box-shadow: 0 6px 18px rgba(22, 163, 74, 0.75); transform: translateY(-1px); }
    .btn-cancel { background: transparent; color: var(--muted); border: 1px solid rgba(75, 85, 99, 0.9); }
    .btn-cancel:hover { border-color: rgba(239, 68, 68, 0.9); color: #fecaca; background: rgba(239, 68, 68, 0.3); transform: translateY(-1px); }
    .status-text { font-size: 12px; margin-top: 6px; color: var(--muted); }
    .status-text span { color: #e5e7eb; }
    #gaugeNeedle { transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.5s; }
    .risk-layout { display: grid; grid-template-columns: 1.3fr 1.7fr; gap: 20px; }
    .gauge-container { display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .gauge-label { font-size: 13px; color: var(--muted); text-align: center; }
    .gauge-status { font-size: 15px; font-weight: 600; }
    .gauge-status.green { color: var(--green); }
    .gauge-status.yellow { color: var(--yellow); }
    .gauge-status.red { color: var(--red); }
    .gauge-description { font-size: 12px; color: var(--muted); text-align: center; max-width: 280px; }
    .targets-table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 12px; }
    .targets-table th, .targets-table td { padding: 6px 8px; border-bottom: 1px solid #111827; text-align: left; }
    .targets-table th { color: var(--muted); font-weight: 500; }
    .targets-table td { color: #e5e7eb; }
    .targets-profit-bad { color: var(--red); }
    .targets-profit-good { color: var(--green); }
    .risk-meta-row { display: flex; justify-content: space-between; gap: 16px; font-size: 12px; margin-bottom: 8px; flex-wrap: wrap; }
    .risk-meta-item { color: var(--muted); }
    .risk-meta-item strong { color: var(--text); }
    .saved-table-wrapper { max-height: 320px; overflow-y: auto; }
    .saved-table { width: 100%; border-collapse: collapse; }
    .saved-table th, .saved-table td { padding: 6px 8px; border-bottom: 1px solid #111827; }
    .saved-table th { text-align: left; color: var(--muted); font-weight: 500; position: sticky; top: 0; background: #020617; }
    .saved-table td { color: #e5e7eb; font-size: 11px; }
    @media (max-width: 900px) { .risk-layout { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header-row">
      <div class="title-block">
        <div class="title-line">
          <div class="title">Trading Control Center</div>
          <div class="portfolio-block">
            <span class="portfolio-label">Portfolio:</span>
            <input id="portfolioInput" class="portfolio-input" type="number" step="0.01" min="0" placeholder="e.g. 5000">
            <span class="margin-text">Margin Amount: <span id="marginAmount" class="margin-value">$0.00</span></span>
          </div>
        </div>
        <div class="subtitle">Fee Structure &amp; Risk Management &bull; TradeZero-style fee model</div>
      </div>
      <div class="clock-block">
        <div class="clock-line" id="clockDisplay">--/--/---- --:-- -- EST</div>
        <div id="marketStatusPill" class="status-pill status-closed"><span id="marketStatusText">Market Closed</span></div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-tab="fees"><span class="tab-icon">üìä</span>Fee Structure</button>
      <button class="tab-button" data-tab="risk"><span class="tab-icon">üõ°Ô∏è</span>Risk Management</button>
      <button class="tab-button" data-tab="saved"><span class="tab-icon">üíæ</span>Saved Trades</button>
    </div>

    <div class="content">
      <div class="tab-panel active" id="tab-fees">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Order Inputs</div>
            <div class="card-note">Fill in symbol, side, price, shares, and locate fee (if short).</div>
          </div>
          <div class="grid-2">
            <div class="field"><label for="symbolInput">Ticker Symbol</label><input id="symbolInput" class="input" type="text" placeholder="e.g. VERO"></div>
            <div class="field"><label for="orderType">Order Type</label><select id="orderType" class="select"><option value="limit">Limit</option><option value="market">Market</option></select></div>
            <div class="field"><label for="side">Side</label><select id="side" class="select"><option value="long">Long</option><option value="short">Short</option></select></div>
            <div class="field"><label for="tradePrice">Trade Price (per share, USD)</label><input id="tradePrice" class="input" type="number" step="0.01" min="0" placeholder="e.g. 10.00"></div>
            <div class="field"><label for="shares">Shares</label><input id="shares" class="input" type="number" step="1" min="0" placeholder="e.g. 100"></div>
            <div class="field"><label for="locatePrice">Locate Fee (USD, for shorts)</label><input id="locatePrice" class="input" type="number" step="0.01" min="0" placeholder="e.g. 1.12"></div>
          </div>
          <hr class="section-divider">
          <div class="summary-row">
            <div class="summary-item">Order: <span id="summaryOrder">--</span></div>
            <div class="summary-item">Gross Amount: <span id="summaryNotional">$0.00</span></div>
            <div class="summary-item">ZeroFree Status: <span id="summaryZeroFree">--</span></div>
            <div><span id="summaryBadge" class="summary-badge">Waiting for input</span></div>
          </div>
          <div class="fees-card">
            <div class="fees-header">
              <div class="fees-title">Fee Breakdown</div>
              <div class="fees-body" style="font-size:11px;">TradeZero commission structure with regulatory fees.</div>
            </div>
            <div class="fees-body">
              <div class="fee-row"><div class="fee-name">Commission</div><div class="fee-value" id="feeCommission">$0.00</div></div>
              <div class="fee-row"><div class="fee-name">TAF</div><div class="fee-value" id="feeTAF">$0.00</div></div>
              <div class="fee-row"><div class="fee-name">Locate Fee</div><div class="fee-value" id="feeLocate">$0.00</div></div>
              <div class="fee-total"><div class="fee-total-label">Total Fees</div><div class="fee-total-value" id="feeTotal">$0.00</div></div>
              <div class="net-row"><div class="net-label">Net Amount (entry cost)</div><div class="net-value" id="netAmount">$0.00</div></div>
            </div>
          </div>
          <div class="status-text">Status: <span id="statusMessage">Waiting for inputs. Fill out price and shares to calculate fees.</span></div>
          <div class="actions-row">
            <button class="btn btn-execute" id="executeButton">‚úÖ Execute Trade</button>
            <button class="btn btn-cancel" id="cancelButton">‚úñ Cancel Trade</button>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tab-risk">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Risk Management</div>
            <div class="card-note">Position risk analysis based on your margin and fees.</div>
          </div>
          <div class="risk-layout">
            <div class="gauge-container">
              <svg id="riskGauge" width="240" height="240" viewBox="0 0 240 240">
                <circle cx="120" cy="120" r="90" fill="none" stroke="#0b1120" stroke-width="28"></circle>
                <circle cx="120" cy="120" r="90" fill="none" stroke="#22c55e" stroke-width="28" stroke-linecap="round" stroke-dasharray="192 565" transform="rotate(-90 120 120)"></circle>
                <circle cx="120" cy="120" r="90" fill="none" stroke="#fbbf24" stroke-width="28" stroke-linecap="round" stroke-dasharray="180 565" stroke-dashoffset="-192" transform="rotate(-90 120 120)"></circle>
                <circle cx="120" cy="120" r="90" fill="none" stroke="#f97373" stroke-width="28" stroke-linecap="round" stroke-dasharray="192 565" stroke-dashoffset="-372" transform="rotate(-90 120 120)"></circle>
                <circle cx="120" cy="120" r="64" fill="#020617"></circle>
                <line id="gaugeNeedle" x1="120" y1="120" x2="120" y2="34" stroke="#e5e7eb" stroke-width="3" stroke-linecap="round" transform="rotate(0 120 120)"></line>
                <circle cx="120" cy="120" r="5" fill="#e5e7eb"></circle>
                <text id="gaugePercentText" x="120" y="145" text-anchor="middle" fill="#e5e7eb" font-size="18" font-weight="600">0%</text>
              </svg>
              <div class="gauge-label">Risk usage: Net Amount √∑ Margin Amount</div>
              <div id="gaugeStatusText" class="gauge-status green">Acceptable / Controlled Risk</div>
              <div id="gaugeDescription" class="gauge-description">Enter portfolio value and order details to see position risk.</div>
            </div>
            <div class="targets-card">
              <div class="risk-meta-row">
                <div class="risk-meta-item"><span>Margin Portfolio:</span> <strong id="riskMargin">$0.00</strong></div>
                <div class="risk-meta-item"><span>Risked Amount (Net):</span> <strong id="riskNetUsed">$0.00</strong></div>
                <div class="risk-meta-item"><span>Side:</span> <strong id="riskSideLabel">--</strong></div>
              </div>
              <div class="card-note" style="margin-bottom:6px;">Profit Targets (price movement needed after fees)</div>
              <table class="targets-table">
                <thead><tr><th>Percent Range</th><th>Dollar Range</th></tr></thead>
                <tbody id="targetsBody"><tr><td colspan="2" style="text-align:center;color:var(--muted);">No trade data yet</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-panel" id="tab-saved">
        <div class="card">
          <div class="card-title-row">
            <div class="card-title">Saved Trades (Browser Log)</div>
            <div class="card-note">Stored locally in your browser. Clearing browser data will erase this log.</div>
          </div>
          <div class="saved-table-wrapper">
            <table class="saved-table">
              <thead><tr><th>Date</th><th>Time</th><th>Symbol</th><th>Side</th><th>Type</th><th style="text-align:right;">Price</th><th style="text-align:right;">Shares</th><th style="text-align:right;">Fees</th><th style="text-align:right;">Net</th></tr></thead>
              <tbody id="savedBody"><tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px;">No saved trades yet</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
(function() {
  'use strict';

  let portfolioValue = 0;

  function fmt(v) {
    if (!isFinite(v)) return "$0.00";
    return "$" + v.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function parse(t) {
    if (!t) return 0;
    return parseFloat(String(t).replace(/[^0-9.-]/g, "")) || 0;
  }

  function toEst(d) {
    const utc = d.getTime() + d.getTimezoneOffset() * 60000;
    return new Date(utc + (-5 * 3600000));
  }

  function getStatus(e) {
    const d = e.getDay();
    const m = e.getHours() * 60 + e.getMinutes();
    if (d === 0 || d === 6) return { status: "Market Closed", class: "status-closed" };
    if (m >= 240 && m < 540) return { status: "Pre-Market", class: "status-pre" };
    if (m >= 540 && m < 960) return { status: "Market Hours", class: "status-open" };
    if (m >= 960 && m < 1200) return { status: "After Market Hours", class: "status-after" };
    return { status: "Market Closed", class: "status-closed" };
  }

  function getLev(e, p) {
    if (p < 500) return 1;
    const m = e.getHours() * 60 + e.getMinutes();
    if (m >= 240 && m < 960) return 3;
    if (m >= 960 && m < 1200) return 2;
    return 2;
  }

  const els = {
    clock: document.getElementById("clockDisplay"),
    pill: document.getElementById("marketStatusPill"),
    pillText: document.getElementById("marketStatusText"),
    margin: document.getElementById("marginAmount"),
    portfolio: document.getElementById("portfolioInput"),
    symbol: document.getElementById("symbolInput"),
    orderType: document.getElementById("orderType"),
    side: document.getElementById("side"),
    price: document.getElementById("tradePrice"),
    shares: document.getElementById("shares"),
    locate: document.getElementById("locatePrice"),
    summOrder: document.getElementById("summaryOrder"),
    summNot: document.getElementById("summaryNotional"),
    summZero: document.getElementById("summaryZeroFree"),
    summBadge: document.getElementById("summaryBadge"),
    feeComm: document.getElementById("feeCommission"),
    feeTAF: document.getElementById("feeTAF"),
    feeLoc: document.getElementById("feeLocate"),
    feeTotal: document.getElementById("feeTotal"),
    netAmt: document.getElementById("netAmount"),
    status: document.getElementById("statusMessage"),
    execBtn: document.getElementById("executeButton"),
    cancelBtn: document.getElementById("cancelButton"),
    riskNet: document.getElementById("riskNetUsed"),
    riskSide: document.getElementById("riskSideLabel"),
    riskMar: document.getElementById("riskMargin"),
    targets: document.getElementById("targetsBody"),
    saved: document.getElementById("savedBody"),
    needle: document.getElementById("gaugeNeedle"),
    gaugePct: document.getElementById("gaugePercentText"),
    gaugeStatus: document.getElementById("gaugeStatusText"),
    gaugeDesc: document.getElementById("gaugeDescription")
  };

  function updateMargin(e) {
    const lev = getLev(e, portfolioValue);
    const mar = portfolioValue * lev;
    els.margin.textContent = fmt(mar);
    updateGauge();
  }

  function updateClock() {
    const now = new Date();
    const est = toEst(now);
    const mo = String(est.getMonth() + 1).padStart(2, "0");
    const dy = String(est.getDate()).padStart(2, "0");
    const yr = est.getFullYear();
    let hr = est.getHours();
    const mn = String(est.getMinutes()).padStart(2, "0");
    const ap = hr >= 12 ? "PM" : "AM";
    let dh = hr % 12;
    if (dh === 0) dh = 12;
    els.clock.textContent = mo + "/" + dy + "/" + yr + " " + dh + ":" + mn + " " + ap + " EST";
    const st = getStatus(est);
    els.pill.className = "status-pill " + st.class;
    els.pillText.textContent = st.status;
    updateMargin(est);
  }

  setInterval(updateClock, 1000);
  updateClock();

  els.portfolio.addEventListener("input", () => {
    portfolioValue = parseFloat(els.portfolio.value) || 0;
    updateMargin(toEst(new Date()));
  });

  document.querySelectorAll(".tab-button").forEach(b => {
    b.addEventListener("click", () => {
      const tab = b.getAttribute("data-tab");
      document.querySelectorAll(".tab-button").forEach(x => x.classList.remove("active"));
      b.classList.add("active");
      document.querySelectorAll(".tab-panel").forEach(p => {
        p.classList.toggle("active", p.id === "tab-" + tab);
      });
    });
  });

  function calc() {
    const sym = els.symbol.value.trim().toUpperCase();
    const type = els.orderType.value;
    const side = els.side.value;
    const px = parseFloat(els.price.value);
    const sh = parseInt(els.shares.value, 10);
    const loc = parseFloat(els.locate.value) || 0;

    if (!sym && (!sh || !px)) {
      els.summOrder.textContent = "--";
    } else {
      els.summOrder.textContent = (side === "short" ? "Short " : "Long ") + (sh || 0) + " " + (sym || "SYMBOL") + " @ " + (isFinite(px) ? "$" + px.toFixed(2) : "--") + " (" + (type === "limit" ? "Limit" : "Market") + ")";
    }

    let not = 0;
    if (isFinite(px) && isFinite(sh) && sh > 0) not = px * sh;
    els.summNot.textContent = fmt(not);

    if (!isFinite(px) || !isFinite(sh) || sh <= 0 || px <= 0) {
      els.feeComm.textContent = "$0.00";
      els.feeTAF.textContent = "$0.00";
      els.feeLoc.textContent = fmt(loc);
      els.feeTotal.textContent = fmt(loc);
      els.netAmt.textContent = fmt(not + loc);
      els.summZero.textContent = "--";
      els.summBadge.className = "summary-badge";
      els.summBadge.textContent = "Waiting for input";
      els.status.textContent = "Enter price and shares to calculate fees.";
      updateRisk(not, loc, not + loc, side);
      return;
    }

    let zf = false;
    if (type === "limit" && sh >= 200 && px >= 1) zf = true;

    let comm = 0;
    if (zf) {
      comm = 0;
    } else {
      if (sh < 200) comm = 0.99;
      else comm = sh * 0.005;
    }

    let taf = 0.02;
    const locFee = side === "short" ? loc : 0;
    const totFee = comm + taf + locFee;
    const net = not + totFee;

    els.feeComm.textContent = fmt(comm);
    els.feeTAF.textContent = fmt(taf);
    els.feeLoc.textContent = fmt(locFee);
    els.feeTotal.textContent = fmt(totFee);
    els.netAmt.textContent = fmt(net);
    els.summZero.textContent = zf ? "Qualifies (ZeroFree)" : "Paid commission";

    if (zf) {
      els.summBadge.className = "summary-badge free";
      els.summBadge.textContent = "ZeroFree Trade";
      els.status.textContent = "This order meets ZeroFree conditions: Limit, ‚â•200 shares, price ‚â•$1. Commission is $0.00.";
    } else {
      els.summBadge.className = "summary-badge paid";
      els.summBadge.textContent = "Commission Charged";
      els.status.textContent = "This order does not meet ZeroFree rules. Commission and fees apply.";
    }

    updateRisk(not, totFee, net, side);
  }

  function updateRisk(not, fee, net, side) {
    const mar = parse(els.margin.textContent);
    els.riskSide.textContent = side ? side.toUpperCase() : "--";
    els.riskNet.textContent = fmt(net || 0);
    els.riskMar.textContent = fmt(mar || 0);
    updateGauge();
    updateTargets(not, fee);
  }

  function updateGauge() {
    const mar = parse(els.margin.textContent);
    const net = parse(els.netAmt.textContent);
    let pct = 0;
    if (mar > 0 && net > 0) pct = Math.min((net / mar) * 100, 100);
    const ang = (pct / 100) * 360;
    els.needle.setAttribute("transform", "rotate(" + ang + " 120 120)");
    els.gaugePct.textContent = Math.round(pct) + "%";

    let zone = "green";
    let txt = "Acceptable / Controlled Risk";
    let desc = "Position size is within your defined risk range.";

    if (pct >= 35 && pct <= 66) {
      zone = "yellow";
      txt = "Elevated / Watch Carefully";
      desc = "You are using a meaningful portion of available margin. Review if this aligns with your risk plan.";
    } else if (pct > 66) {
      zone = "red";
      txt = "High / Excessive Risk";
      desc = "Position size exceeds your preferred risk; Cut down position size.";
    }

    els.gaugeStatus.className = "gauge-status " + zone;
    els.gaugeStatus.textContent = txt;
    els.gaugeDesc.textContent = desc;
  }

  function updateTargets(not, fee) {
    els.targets.innerHTML = "";
    if (!not || not <= 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.style.textAlign = "center";
      td.style.color = "var(--muted)";
      td.textContent = "No trade data yet";
      tr.appendChild(td);
      els.targets.appendChild(tr);
      return;
    }

    const feeP = not > 0 ? (fee / not) * 100 : 0;

    function row(pct, dol, bad) {
      const tr = document.createElement("tr");
      const td1 = document.createElement("td");
      const td2 = document.createElement("td");
      td1.textContent = pct;
      td2.textContent = dol;
      td2.className = bad ? "targets-profit-bad" : "targets-profit-good";
      tr.appendChild(td1);
      tr.appendChild(td2);
      els.targets.appendChild(tr);
    }

    const fpd = Math.round(feeP * 100) / 100;
    const h1d = (fpd / 100) * not;
    row(0 + "% ‚Äì " + fpd.toFixed(2) + "%", fmt(0) + " ‚Äì " + fmt(h1d), true);

    let base = Math.ceil(feeP / 5) * 5;
    if (base === 0) base = 5;
    let st = base;
    for (let i = 0; i < 5; i++) {
      const en = st + 5;
      const ld = (st / 100) * not;
      const hd = (en / 100) * not;
      row(st + "% ‚Äì " + en + "%", fmt(ld) + " ‚Äì " + fmt(hd), false);
      st = en;
    }
  }

  const LOG_KEY = "tz_trading_control_trades";

  function loadTrades() {
    try {
      const r = localStorage.getItem(LOG_KEY);
      if (!r) return [];
      return JSON.parse(r) || [];
    } catch (e) {
      return [];
    }
  }

  function saveTrades(t) {
    try {
      localStorage.setItem(LOG_KEY, JSON.stringify(t));
    } catch (e) {}
  }

  function addRow(t) {
    if (els.saved.children.length === 1 && els.saved.children[0].children.length === 1) {
      els.saved.innerHTML = "";
    }
    const tr = document.createElement("tr");
    function cell(txt, right) {
      const td = document.createElement("td");
      td.textContent = txt;
      if (right) td.style.textAlign = "right";
      return td;
    }
    tr.appendChild(cell(t.date));
    tr.appendChild(cell(t.time));
    tr.appendChild(cell(t.symbol));
    tr.appendChild(cell(t.side.toUpperCase()));
    tr.appendChild(cell(t.orderType.toUpperCase()));
    tr.appendChild(cell(fmt(t.tradePrice), true));
    tr.appendChild(cell(t.shares, true));
    tr.appendChild(cell(fmt(t.totalFees), true));
    tr.appendChild(cell(fmt(t.netAmount), true));
    els.saved.appendChild(tr);
  }

  function renderSaved() {
    els.saved.innerHTML = "";
    const trades = loadTrades();
    if (trades.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 9;
      td.style.textAlign = "center";
      td.style.color = "var(--muted)";
      td.style.padding = "20px";
      td.textContent = "No saved trades yet";
      tr.appendChild(td);
      els.saved.appendChild(tr);
    } else {
      trades.forEach(addRow);
    }
  }

  function buildPayload() {
    const now = new Date();
    const est = toEst(now);
    const mo = String(est.getMonth() + 1).padStart(2, "0");
    const dy = String(est.getDate()).padStart(2, "0");
    const yr = est.getFullYear();
    let hr = est.getHours();
    const mn = String(est.getMinutes()).padStart(2, "0");
    const ap = hr >= 12 ? "PM" : "AM";
    let dh = hr % 12;
    if (dh === 0) dh = 12;
    return {
      date: mo + "/" + dy + "/" + yr,
      time: dh + ":" + mn + " " + ap,
      symbol: els.symbol.value.trim().toUpperCase(),
      orderType: els.orderType.value,
      side: els.side.value,
      tradePrice: parseFloat(els.price.value) || 0,
      shares: parseInt(els.shares.value, 10) || 0,
      locatePrice: parseFloat(els.locate.value) || 0,
      commission: parse(els.feeComm.textContent),
      taf: parse(els.feeTAF.textContent),
      totalFees: parse(els.feeTotal.textContent),
      netAmount: parse(els.netAmt.textContent)
    };
  }

  function clear() {
    els.symbol.value = "";
    els.orderType.value = "limit";
    els.side.value = "long";
    els.price.value = "";
    els.shares.value = "";
    els.locate.value = "";
    calc();
  }

  els.orderType.addEventListener("change", calc);
  els.side.addEventListener("change", calc);
  els.symbol.addEventListener("input", calc);
  els.price.addEventListener("input", calc);
  els.shares.addEventListener("input", calc);
  els.locate.addEventListener("input", calc);

  els.execBtn.addEventListener("click", () => {
    calc();
    const p = buildPayload();
    if (!p.symbol || !p.shares || !p.tradePrice) {
      alert("Please enter symbol, price, and shares before executing.");
      return;
    }
    const trades = loadTrades();
    trades.push(p);
    saveTrades(trades);
    addRow(p);
    clear();
    alert("Trade executed and saved to browser log.");
  });

  els.cancelBtn.addEventListener("click", () => {
    clear();
  });

  calc();
  renderSaved();
})();
  </script>
</body>
</html>
